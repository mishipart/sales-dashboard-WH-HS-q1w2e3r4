<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ë°©ì†¡ ë§¤ì¶œ ëŒ€ì‹œë³´ë“œ</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root{
      --bg:#f5f7fb; --card:#fff; --line:#e7ecf5; --text:#111827; --muted:#6b7280;
      --primary:#60a5fa; --pink:#fda4af; --orange:#fb923c;
      --pill:#ffffff; --pillOn:#e8f1ff;
      --radius:14px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;}
    .wrap{max-width:1360px;margin:18px auto;padding:0 14px;}
    h1{margin:0 0 6px;font-size:28px;display:flex;align-items:center;gap:10px}
    .sub{color:var(--muted);font-size:12px;margin-bottom:12px}
    .statusbar{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:10px 12px;display:flex;align-items:center;justify-content:space-between;gap:10px}
    .status{font-size:13px}
    .btn{border:1px solid var(--line);background:#fff;border-radius:10px;padding:7px 10px;font-size:12px;cursor:pointer}
    .btn.primary{border-color:#cfe0ff;background:#edf4ff}
    .grid{display:grid;grid-template-columns:340px 1fr;gap:14px;margin-top:14px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:12px}
    .kpis{display:grid;grid-template-columns:repeat(6,minmax(0,1fr));gap:10px}
    .kpi{background:#eaf2ff;border-radius:14px;padding:10px 12px;min-height:62px}
    .kpi .t{font-size:12px;color:#335;opacity:.9}
    .kpi .v{font-size:20px;font-weight:800;margin-top:4px}
    .filters h3{margin:0 0 10px;font-size:14px}
    .fblock{margin-bottom:10px}
    .fhead{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
    .fname{font-weight:700;font-size:13px}
    .pillbox{display:flex;flex-wrap:wrap;gap:6px}
    .pill{
      border:1px solid var(--line);background:var(--pill);
      border-radius:999px;padding:6px 9px;font-size:12px;cursor:pointer;user-select:none;
    }
    .pill.on{background:var(--pillOn);border-color:#cfe0ff}
    .chartGrid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .chartCard{padding:10px 12px}
    .chartTitle{font-weight:800;margin:2px 0 8px}
    canvas{width:100%!important;height:260px!important;} /* âœ… ê·¸ë˜í”„ í¬ê¸° ì¤„ì„ */
    .wide canvas{height:260px!important;}
    .wide2 canvas{height:300px!important;}
    .footnote{color:var(--muted);font-size:11px;margin-top:8px}
    /* --- Modal --- */
    .modalBg{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;padding:12px}
    .modal{background:#fff;border-radius:16px;max-width:420px;width:100%;padding:14px;border:1px solid var(--line)}
    .modal h2{margin:0 0 8px;font-size:16px}
    .modal p{margin:0 0 10px;color:var(--muted);font-size:12px}
    .modal input{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:12px;font-size:14px}
    .modal .row{display:flex;gap:8px;margin-top:10px}
    .modal .row button{flex:1}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>ğŸ“Š ë°©ì†¡ ë§¤ì¶œ ëŒ€ì‹œë³´ë“œ</h1>
    <div class="sub">ì—‘ì…€ ìŠ¬ë¼ì´ì„œì²˜ëŸ¼ ì„ íƒí•˜ë©´ KPI/ì°¨íŠ¸ê°€ ì¦‰ì‹œ ë³€ê²½ë©ë‹ˆë‹¤.</div>

    <div class="statusbar">
      <div class="status" id="statusText">ìƒíƒœ: ì¤€ë¹„ ì¤‘</div>
      <div style="display:flex;gap:8px;align-items:center;">
        <div style="font-size:12px;color:var(--muted)" id="updatedText"></div>
        <button class="btn" id="btnReset">ì „ì²´ í•´ì œ</button>
        <button class="btn primary" id="btnReload">ìƒˆë¡œê³ ì¹¨</button>
        <button class="btn" id="btnKey">í‚¤ ë³€ê²½</button>
      </div>
    </div>

    <div class="grid">
      <div class="card filters">
        <h3>í•„í„°(ìŠ¬ë¼ì´ì„œ)</h3>

        <div id="filters"></div>

        <div class="footnote">â€» í‚¤ë¥¼ ëª¨ë¥´ë©´ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>
      </div>

      <div class="card">
        <div class="kpis" id="kpis"></div>

        <div style="height:10px"></div>

        <div class="chartGrid">
          <div class="card chartCard">
            <div class="chartTitle">ë°©ì†¡ì±„ë„ë³„ (ëª©í‘œ/ì‹¤ì /ë‹¬ì„±ìœ¨)</div>
            <canvas id="chChannel"></canvas>
          </div>

          <div class="card chartCard">
            <div class="chartTitle">ì›”ë³„ (ëª©í‘œ/ì‹¤ì /ë‹¬ì„±ìœ¨)</div>
            <canvas id="chMonth"></canvas>
          </div>

          <div class="card chartCard">
            <div class="chartTitle">ìš”ì¼ë³„ (ëª©í‘œ/ì‹¤ì /ë‹¬ì„±ìœ¨)</div>
            <canvas id="chDow"></canvas>
          </div>

          <div class="card chartCard wide">
            <div class="chartTitle">ì¼ìë³„ (ëª©í‘œ/ì‹¤ì /ë‹¬ì„±ìœ¨) - TOP 30</div>
            <canvas id="chDay"></canvas>
          </div>

          <div class="card chartCard wide2" style="grid-column:1/-1;">
            <div class="chartTitle">ì•„ì´í…œë³„ (ëª©í‘œ/ì‹¤ì /ë‹¬ì„±ìœ¨)</div>
            <canvas id="chItem"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Key Modal -->
  <div class="modalBg" id="modalBg">
    <div class="modal">
      <h2>ì ‘ê·¼ í‚¤ ì…ë ¥</h2>
      <p>í‚¤ë¥¼ ì…ë ¥í•´ì•¼ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤. (ì €ì¥ì€ ë¸Œë¼ìš°ì € ë¡œì»¬ì—ë§Œ ì €ì¥ë©ë‹ˆë‹¤)</p>
      <input id="keyInput" placeholder="ì˜ˆ: WHHS-XXXX-XXXX" />
      <div class="row">
        <button class="btn" id="btnCancel">ì·¨ì†Œ</button>
        <button class="btn primary" id="btnSaveKey">í™•ì¸</button>
      </div>
    </div>
  </div>

<script>
/*** =========================
 *  1) ì„¤ì •
 * ========================= */
// âœ… ë„ˆì˜ Apps Script ì›¹ì•± URL (execë¡œ ëë‚˜ëŠ” URL)
const API_URL = "https://script.google.com/macros/s/AKfycbzpLQ2wcNZIuisAjsaDTxA_Lj1E5X6CWEeZffW0_PPdjHTAo7peoHig1UmzyvXbkLHUuw/exec";

// (í‚¤ëŠ” íŒì—…ì—ì„œ ì…ë ¥)
const KEY_STORAGE = "WHHS-PSM-221035";

/*** =========================
 *  2) ìƒíƒœ/í•„í„° ìƒíƒœ
 * ========================= */
const state = {
  filters: {
    years: [],
    months: [],
    days: [],
    dows: [],
    items: [],
    channels: []
  },
  options: null,
  charts: {},
  chartObjs: {}
};

const DOW_ORDER = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];

/*** =========================
 *  3) JSONP
 * ========================= */
function jsonp(url, params){
  return new Promise((resolve, reject)=>{
    const cb = "cb_" + Math.random().toString(36).slice(2);
    const qs = new URLSearchParams(params);
    qs.set("callback", cb);
    const src = url + (url.includes("?") ? "&" : "?") + qs.toString();

    const s = document.createElement("script");
    let done = false;

    window[cb] = (data)=>{
      done = true;
      cleanup();
      resolve(data);
    };

    function cleanup(){
      try { delete window[cb]; } catch(e){ window[cb]=undefined; }
      if (s && s.parentNode) s.parentNode.removeChild(s);
    }

    s.onerror = ()=>{
      if (done) return;
      cleanup();
      reject(new Error("JSONP load failed"));
    };

    document.head.appendChild(s);
    s.src = src;

    setTimeout(()=>{
      if (done) return;
      cleanup();
      reject(new Error("JSONP timeout"));
    }, 15000);
  });
}

/*** =========================
 *  4) UI ë Œë”
 * ========================= */
function setStatus(text, isError=false){
  const el = document.getElementById("statusText");
  el.textContent = text;
  el.style.color = isError ? "#b91c1c" : "#111827";
}

function fmtNum(x){
  const n = Number(x||0);
  return n.toLocaleString('ko-KR', { maximumFractionDigits: 2 });
}
function fmtPct(x){
  const n = Number(x||0);
  return n.toLocaleString('ko-KR', { maximumFractionDigits: 1 }) + "%";
}

function renderKpis(k){
  const kpis = [
    { t:"ë°©ì†¡íšŸìˆ˜", v: fmtNum(k.ë°©ì†¡íšŸìˆ˜) },
    { t:"íŠ¹ì•½íšŸìˆ˜", v: fmtNum(k.íŠ¹ì•½íšŸìˆ˜) },
    { t:"íŠ¹ì•½ë¹„ìš©", v: fmtNum(k.íŠ¹ì•½ë¹„ìš©) },
    { t:"í‰ê· ë‹¬ì„±ìœ¨", v: fmtPct(k.í‰ê· ë‹¬ì„±ìœ¨) },          // âœ… 80% í˜•íƒœ
    { t:"ë°©ì†¡ì‹œê°„(ë¶„)", v: fmtNum(k.ë°©ì†¡ì‹œê°„_ë¶„) },
    { t:"ì‹œê°„ë‹¹ë§¤ì¶œ", v: fmtNum(k.ì‹œê°„ë‹¹ë§¤ì¶œ) }
  ];
  const box = document.getElementById("kpis");
  box.innerHTML = kpis.map(x=>`
    <div class="kpi">
      <div class="t">${x.t}</div>
      <div class="v">${x.v}</div>
    </div>
  `).join("");
}

function renderFilters(options){
  state.options = options;
  const root = document.getElementById("filters");

  // ì •ë ¬ ë³´ì •(í˜¹ì‹œ ì„œë²„ ì˜µì…˜ì´ ì„ì—¬ë„ í”„ë¡ íŠ¸ì—ì„œ í•œ ë²ˆ ë” ë³´ì •)
  const years = (options.years||[]).slice().sort((a,b)=>Number(a)-Number(b));
  const months = (options.months||[]).slice().sort((a,b)=>Number(a)-Number(b));
  const days = (options.days||[]).slice().sort((a,b)=>Number(a)-Number(b));
  const dows = DOW_ORDER.filter(d => (options.dows||[]).includes(d));
  const items = (options.items||[]).slice().sort((a,b)=>a.localeCompare(b,'ko'));
  const channels = (options.channels||[]).slice().sort((a,b)=>a.localeCompare(b,'ko'));

  const blocks = [
    { key:"years", label:"ì—°ë„", values: years },
    { key:"months", label:"ì›”", values: months },
    { key:"days", label:"ì¼", values: days },
    { key:"dows", label:"ìš”ì¼", values: dows },
    { key:"items", label:"ì•„ì´í…œ", values: items },
    { key:"channels", label:"ë°©ì†¡ì±„ë„", values: channels },
  ];

  root.innerHTML = blocks.map(b=>{
    return `
      <div class="fblock">
        <div class="fhead">
          <div class="fname">${b.label}</div>
          <div style="display:flex;gap:6px">
            <button class="btn" data-act="all" data-key="${b.key}">ì „ì²´</button>
            <button class="btn" data-act="clear" data-key="${b.key}">í•´ì œ</button>
          </div>
        </div>
        <div class="pillbox">
          ${b.values.map(v=>{
            const on = state.filters[b.key].includes(String(v));
            return `<div class="pill ${on?'on':''}" data-key="${b.key}" data-val="${String(v)}">${String(v)}</div>`;
          }).join("")}
        </div>
      </div>
    `;
  }).join("");

  // pill click
  root.querySelectorAll(".pill").forEach(el=>{
    el.addEventListener("click", ()=>{
      const k = el.dataset.key;
      const v = el.dataset.val;
      const arr = state.filters[k];
      const i = arr.indexOf(v);
      if (i >= 0) arr.splice(i,1);
      else arr.push(v);
      reloadDashboard();
    });
  });

  // all/clear
  root.querySelectorAll("button[data-act]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const act = btn.dataset.act;
      const k = btn.dataset.key;
      if (act === "clear") state.filters[k] = [];
      if (act === "all") {
        // ì „ì²´ ì„ íƒì€ ë„ˆë¬´ ë¬´ê±°ìš¸ ìˆ˜ ìˆì–´: ì—¬ê¸°ì„œëŠ” "ì „ë¶€ ì„ íƒ" ëŒ€ì‹  "ë¹„ì›€(=ì „ì²´)"ë¡œ ë™ì‘ì‹œí‚´
        state.filters[k] = [];
      }
      reloadDashboard();
    });
  });
}

/*** =========================
 *  5) Chart.js ìƒì„±/ì—…ë°ì´íŠ¸
 *  - ë‹¬ì„±ìœ¨: ì (Scatter), í¬ê¸° í¬ê²Œ
 *  - ì„  ì—°ê²° ì—†ìŒ(showLine:false)
 * ========================= */
function buildComboChart(ctx, title, labels, goal, actual, rate, opts={}){
  const pointR = opts.pointRadius ?? 6;         // âœ… ì  í¬ê²Œ
  const pointHR = opts.pointHoverRadius ?? 8;

  return new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [
        { label:'ëª©í‘œ', data: goal, backgroundColor:'rgba(96,165,250,0.55)' },
        { label:'ì‹¤ì ', data: actual, backgroundColor:'rgba(253,164,175,0.65)' },
        {
          type: 'scatter',
          label:'ë‹¬ì„±ìœ¨(%)',
          data: rate.map((y,i)=>({x:i, y})),
          yAxisID: 'y1',
          showLine: false,                      // âœ… ì„  ì—†ìŒ
          pointRadius: pointR,
          pointHoverRadius: pointHR,
          pointBackgroundColor:'rgba(251,146,60,0.9)'
        }
      ]
    },
    options: {
      responsive:true,
      maintainAspectRatio:false,
      plugins: {
        legend: { position:'top' },
        tooltip: {
          callbacks:{
            label: (ctx)=>{
              if (ctx.dataset.type === 'scatter') return `ë‹¬ì„±ìœ¨: ${Number(ctx.raw.y||0).toFixed(1)}%`;
              return `${ctx.dataset.label}: ${fmtNum(ctx.raw)}`;
            }
          }
        }
      },
      scales: {
        x: {
          ticks: { maxRotation: 45, minRotation: 45 }
        },
        y: {
          beginAtZero:true,
          grid: { color:'rgba(0,0,0,0.06)' }
        },
        y1: {
          position:'right',
          beginAtZero:true,
          grid: { drawOnChartArea:false },
          ticks: {
            callback:(v)=> v + "%"
          }
        }
      }
    }
  });
}

function buildHorizontalCombo(ctx, labels, goal, actual, rate){
  return new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [
        { label:'ëª©í‘œ', data: goal, backgroundColor:'rgba(96,165,250,0.55)' },
        { label:'ì‹¤ì ', data: actual, backgroundColor:'rgba(253,164,175,0.65)' },
        {
          type:'scatter',
          label:'ë‹¬ì„±ìœ¨(%)',
          data: rate.map((y,i)=>({x:y, y:i})),
          xAxisID:'x1',
          showLine:false,
          pointRadius: 6,
          pointHoverRadius: 8,
          pointBackgroundColor:'rgba(251,146,60,0.9)'
        }
      ]
    },
    options: {
      responsive:true,
      maintainAspectRatio:false,
      indexAxis:'y',
      plugins:{ legend:{position:'top'} },
      scales:{
        x:{ beginAtZero:true, grid:{ color:'rgba(0,0,0,0.06)'} },
        x1:{
          position:'top',
          beginAtZero:true,
          grid:{ drawOnChartArea:false },
          ticks:{ callback:(v)=>v+'%' }
        },
        y:{ grid:{ color:'rgba(0,0,0,0.06)'} }
      }
    }
  });
}

function upsertChart(id, builder){
  const ctx = document.getElementById(id).getContext('2d');
  if (state.chartObjs[id]) state.chartObjs[id].destroy();
  state.chartObjs[id] = builder(ctx);
}

/*** =========================
 *  6) ë°ì´í„° ë¡œë“œ
 * ========================= */
function getKey(){
  return localStorage.getItem(KEY_STORAGE) || "";
}
function openKeyModal(){
  document.getElementById("modalBg").style.display="flex";
  document.getElementById("keyInput").value = getKey();
  document.getElementById("keyInput").focus();
}
function closeKeyModal(){
  document.getElementById("modalBg").style.display="none";
}

async function loadDashboard(){
  const key = getKey();
  if (!key) {
    openKeyModal();
    setStatus("ìƒíƒœ: í‚¤ ì…ë ¥ í•„ìš”", true);
    return;
  }

  setStatus("ìƒíƒœ: ë¡œë”© ì¤‘...");
  const params = {
    action: "dashboard",
    key,
    years: state.filters.years.join(","),
    months: state.filters.months.join(","),
    days: state.filters.days.join(","),
    dows: state.filters.dows.join(","),
    items: state.filters.items.join(","),
    channels: state.filters.channels.join(",")
  };

  try{
    const data = await jsonp(API_URL, params);
    if (!data.ok) {
      setStatus(`ìƒíƒœ: ì˜¤ë¥˜ - ${data.message || data.error}`, true);
      return;
    }

    document.getElementById("updatedText").textContent = `ì—…ë°ì´íŠ¸: ${data.updated || ""}`;
    setStatus("ìƒíƒœ: ì •ìƒ Â· í•„í„° ì ìš© ì™„ë£Œ");

    renderKpis(data.kpis || {});
    if (!state.options) renderFilters(data.options || {});

    // charts
    const c = data.charts || {};
    // 1) ì±„ë„: ì„œë²„ì—ì„œ ë¬¸ìì—´ ë‚´ë¦¼ì°¨ìˆœ + (ë¹„ì–´ìˆìŒ) ì œê±° ì²˜ë¦¬ë¨
    upsertChart("chChannel", (ctx)=>buildComboChart(ctx, "ì±„ë„", c.channel?.labels||[], c.channel?.goal||[], c.channel?.actual||[], c.channel?.rate||[], {pointRadius:7}));

    // 2) ì›”, ìš”ì¼: ì„¸ë¡œë§‰ëŒ€
    upsertChart("chMonth", (ctx)=>buildComboChart(ctx, "ì›”", c.month?.labels||[], c.month?.goal||[], c.month?.actual||[], c.month?.rate||[], {pointRadius:7}));
    upsertChart("chDow", (ctx)=>buildComboChart(ctx, "ìš”ì¼", c.dow?.labels||[], c.dow?.goal||[], c.dow?.actual||[], c.dow?.rate||[], {pointRadius:7}));

    // 3) ì¼ì: ê°€ë¡œë§‰ëŒ€(Top30)
    upsertChart("chDay", (ctx)=>buildHorizontalCombo(ctx, c.day?.labels||[], c.day?.goal||[], c.day?.actual||[], c.day?.rate||[]));

    // 4) ì•„ì´í…œ: ì„¸ë¡œë§‰ëŒ€ + ë‹¬ì„±ìœ¨ ì (ì„  ì—†ìŒ)
    upsertChart("chItem", (ctx)=>buildComboChart(ctx, "ì•„ì´í…œ", c.item?.labels||[], c.item?.goal||[], c.item?.actual||[], c.item?.rate||[], {pointRadius:7}));

  }catch(err){
    setStatus("ìƒíƒœ: ì˜¤ë¥˜ Â· JSONP load failed", true);
    console.error(err);
  }
}

function reloadDashboard(){
  // í•„í„° UIë¥¼ ì¦‰ì‹œ ë‹¤ì‹œ ê·¸ë ¤ì„œ on/off í‘œì‹œ ë°˜ì˜
  if (state.options) renderFilters(state.options);
  loadDashboard();
}

/*** =========================
 *  7) ì´ë²¤íŠ¸ ë°”ì¸ë”©
 * ========================= */
document.getElementById("btnReload").addEventListener("click", ()=>loadDashboard());
document.getElementById("btnReset").addEventListener("click", ()=>{
  state.filters = { years:[], months:[], days:[], dows:[], items:[], channels:[] };
  reloadDashboard();
});
document.getElementById("btnKey").addEventListener("click", ()=>openKeyModal());

document.getElementById("btnCancel").addEventListener("click", ()=>closeKeyModal());
document.getElementById("btnSaveKey").addEventListener("click", ()=>{
  const v = document.getElementById("keyInput").value.trim();
  if (!v) return;
  localStorage.setItem(KEY_STORAGE, v);
  closeKeyModal();
  // ì˜µì…˜ ì•„ì§ ì—†ìœ¼ë©´ ì²« ë¡œë“œì—ì„œ ë°›ì•„ì˜¤ê³ , ìˆìœ¼ë©´ ê·¸ëŒ€ë¡œ
  loadDashboard();
});

// ì‹œì‘
(async function init(){
  if (!getKey()) openKeyModal();
  await loadDashboard();
})();
</script>
</body>
</html>
