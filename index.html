<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ë°©ì†¡ ë§¤ì¶œ ëŒ€ì‹œë³´ë“œ</title>
  <meta name="robots" content="noindex,nofollow" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg:#f5f7fb; --card:#fff; --muted:#6b7280; --text:#111827;
      --border:#e5e7eb; --soft:#eaf2ff; --accent:#2563eb;
      --radius:14px;
    }
    body{ font-family: system-ui, -apple-system, Segoe UI, Roboto, "Apple SD Gothic Neo","Noto Sans KR",sans-serif;
      background:var(--bg); margin:0; padding:18px; color:var(--text); }
    header{ display:flex; align-items:center; gap:10px; margin-bottom:8px; }
    header h1{ margin:0; font-size:28px; letter-spacing:-.4px; }
    .sub{ margin:0 0 14px 0; color:var(--muted); font-size:13px; }

    .grid{ display:grid; grid-template-columns: 360px 1fr; gap:14px; align-items:start; }
    @media(max-width:1050px){ .grid{ grid-template-columns:1fr; } }

    .panel{ background:var(--card); border:1px solid var(--border); border-radius:var(--radius); padding:12px; }
    .panel h2{ margin:0 0 8px 0; font-size:16px; }
    .hint{ color:var(--muted); font-size:12px; margin-top:6px; }

    .status{ display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;
      border:1px solid var(--border); border-radius:var(--radius); background:var(--card); padding:10px 12px; }
    .status b{ font-weight:800; }
    .btn{ border:1px solid var(--border); background:#fff; border-radius:10px; padding:8px 10px; cursor:pointer; font-size:13px; }
    .btn:hover{ background:#f9fafb; }
    .btn.primary{ border-color:#c7d2fe; background:#eef2ff; }

    .kpis{ display:grid; grid-template-columns: repeat(4, minmax(150px, 1fr)); gap:12px; margin-top:12px; }
    @media(max-width:920px){ .kpis{ grid-template-columns: repeat(2, minmax(150px, 1fr)); } }
    @media(max-width:520px){ .kpis{ grid-template-columns:1fr; } }
    .kpi{ background:var(--soft); border-radius:var(--radius); padding:14px 16px; }
    .kpi .label{ color:var(--muted); font-size:12px; margin-bottom:6px; }
    .kpi .value{ font-size:22px; font-weight:900; letter-spacing:-.4px; }

    .slicer{ margin-top:10px; }
    .slicer-head{ display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .slicer-head .title{ font-weight:800; }
    .chips{ display:flex; flex-wrap:wrap; gap:8px; margin-top:8px; }
    .chip{
      border:1px solid var(--border); background:#fff; border-radius:999px;
      padding:7px 10px; font-size:13px; cursor:pointer; user-select:none;
    }
    .chip.on{ border-color:#bfdbfe; background:#eff6ff; color:#1d4ed8; font-weight:700; }
    .chip:active{ transform: translateY(1px); }

    .section{ background:var(--card); border:1px solid var(--border); border-radius:var(--radius);
      padding:12px; margin-top:12px; }
    .section h3{ margin:0 0 10px 0; font-size:16px; }
    canvas{ width:100% !important; max-height:380px; }
  </style>
</head>

<body>
  <header>
    <div style="font-size:30px">ğŸ“Š</div>
    <h1>ë°©ì†¡ ë§¤ì¶œ ëŒ€ì‹œë³´ë“œ</h1>
  </header>
  <p class="sub">ì—‘ì…€ ìŠ¬ë¼ì´ì„œì²˜ëŸ¼ ë²„íŠ¼ì„ ëˆŒëŸ¬ í•„í„°ë§í•˜ë©´ KPI/ì°¨íŠ¸ê°€ ì¦‰ì‹œ ë³€ê²½ë©ë‹ˆë‹¤.</p>

  <div class="status">
    <div>ìƒíƒœ: <b id="statusText">ë¡œë”©â€¦</b> <span id="statusHint" style="color:var(--muted)"></span></div>
    <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
      <span id="lastUpdated" style="color:var(--muted); font-size:13px;"></span>
      <button class="btn" id="resetBtn">ì „ì²´ í•´ì œ</button>
      <button class="btn primary" id="refreshBtn">ìƒˆë¡œê³ ì¹¨</button>
    </div>
  </div>

  <div class="grid" style="margin-top:14px;">
    <!-- LEFT: slicers -->
    <div class="panel">
      <h2>í•„í„°(ìŠ¬ë¼ì´ì„œ)</h2>

      <div class="slicer" id="slicerYears"></div>
      <div class="slicer" id="slicerMonths"></div>
      <div class="slicer" id="slicerDows"></div>
      <div class="slicer" id="slicerItems"></div>
      <div class="slicer" id="slicerChannels"></div>

      <div class="hint">íŒ: ì—¬ëŸ¬ ê°œë¥¼ ë™ì‹œì— ì„ íƒí•  ìˆ˜ ìˆì–´ìš”(ì—‘ì…€ ìŠ¬ë¼ì´ì„œì™€ ë™ì¼).</div>
    </div>

    <!-- RIGHT: KPIs + Charts -->
    <div>
      <div class="kpis" id="kpis"></div>

      <div class="section">
        <h3>ë°©ì†¡ì±„ë„ë³„ ë‹¬ì„±ìœ¨</h3>
        <canvas id="channelChart"></canvas>
      </div>

      <div class="section">
        <h3>ì•„ì´í…œë³„ ë‹¬ì„±ìœ¨</h3>
        <canvas id="itemChart"></canvas>
      </div>

      <div class="section">
        <h3>ì›”ë³„ ë‹¬ì„±ìœ¨</h3>
        <canvas id="monthChart"></canvas>
      </div>

      <div class="section">
        <h3>ìš”ì¼ë³„ ë‹¬ì„±ìœ¨</h3>
        <canvas id="dowChart"></canvas>
      </div>
    </div>
  </div>

<script>
/*** âœ… ë³¸ì¸ Apps Script exec URL ì…ë ¥ ***/
const API_URL = "https://script.google.com/macros/s/AKfycbzpLQ2wcNZIuisAjsaDTxA_Lj1E5X6CWEeZffW0_PPdjHTAo7peoHig1UmzyvXbkLHUuw/exec"; // â† ì´ê²ƒë§Œ ë°”ê¾¸ì„¸ìš”

/*** JSONP ìœ í‹¸ ***/
function jsonp(url){
  return new Promise((resolve, reject) => {
    const cb = "cb_" + Math.random().toString(36).slice(2);
    const script = document.createElement("script");
    window[cb] = (data) => {
      resolve(data);
      try{ delete window[cb]; }catch(e){ window[cb]=undefined; }
      script.remove();
    };
    const sep = url.includes("?") ? "&" : "?";
    script.src = url + sep + "callback=" + cb;
    script.onerror = () => {
      reject(new Error("JSONP load failed"));
      try{ delete window[cb]; }catch(e){ window[cb]=undefined; }
      script.remove();
    };
    document.body.appendChild(script);
  });
}

/*** ìƒíƒœ/UI ***/
function setStatus(ok, text, hint=""){
  const el = document.getElementById("statusText");
  const hintEl = document.getElementById("statusHint");
  el.textContent = text;
  hintEl.textContent = hint ? ` Â· ${hint}` : "";
  el.style.color = ok ? "#059669" : "#dc2626";
}
function updateTimestamp(){
  document.getElementById("lastUpdated").textContent =
    "ì—…ë°ì´íŠ¸: " + new Date().toLocaleString("ko-KR");
}
function fmtNumber(x){
  const n = Number(x);
  if(!isFinite(n)) return "-";
  return Math.round(n).toLocaleString("ko-KR");
}
function fmtPercent01(x){
  const n = Number(x);
  if(!isFinite(n)) return "-";
  return Math.round(n*100) + "%";
}

/*** ì„ íƒ ìƒíƒœ(ì—‘ì…€ ìŠ¬ë¼ì´ì„œì²˜ëŸ¼ ë©€í‹°) ***/
const state = {
  years: new Set(),
  months: new Set(),
  dows: new Set(),
  items: new Set(),
  channels: new Set(),
};

// URL ì¿¼ë¦¬ì— ì„ íƒìƒíƒœ ì €ì¥/ë³µì› (ê³µìœ  ë§í¬ì—ë„ ìœ ì§€)
function readStateFromUrl(){
  const sp = new URLSearchParams(location.search);
  ["years","months","dows","items","channels"].forEach(k=>{
    state[k].clear();
    const v = sp.get(k);
    if(v){
      v.split(",").map(s=>s.trim()).filter(Boolean).forEach(x=>state[k].add(x));
    }
  });
}
function writeStateToUrl(){
  const sp = new URLSearchParams();
  ["years","months","dows","items","channels"].forEach(k=>{
    if(state[k].size) sp.set(k, [...state[k]].join(","));
  });
  const newUrl = location.pathname + (sp.toString()?("?"+sp.toString()):"");
  history.replaceState(null, "", newUrl);
}

function buildQueryFromState(){
  const sp = new URLSearchParams();
  ["years","months","dows","items","channels"].forEach(k=>{
    if(state[k].size) sp.set(k, [...state[k]].join(","));
  });
  return sp.toString();
}

/*** ìŠ¬ë¼ì´ì„œ ë Œë”(ì¹© ë²„íŠ¼) ***/
function renderSlicer(containerId, title, key, options){
  const container = document.getElementById(containerId);
  const selected = state[key];

  const chipsHtml = (options || []).map(v=>{
    const on = selected.has(String(v));
    return `<div class="chip ${on?'on':''}" data-key="${key}" data-val="${String(v)}">${String(v)}</div>`;
  }).join("");

  container.innerHTML = `
    <div class="slicer-head">
      <div class="title">${title}</div>
      <div style="display:flex; gap:6px;">
        <button class="btn" data-action="all" data-key="${key}">ì „ì²´ì„ íƒ</button>
        <button class="btn" data-action="none" data-key="${key}">í•´ì œ</button>
      </div>
    </div>
    <div class="chips">${chipsHtml || '<span style="color:var(--muted);font-size:13px;">(ì˜µì…˜ ì—†ìŒ)</span>'}</div>
  `;
}

/*** KPI ***/
function renderKpis(d){
  document.getElementById("kpis").innerHTML = `
    <div class="kpi"><div class="label">ë°©ì†¡íšŸìˆ˜</div><div class="value">${fmtNumber(d["ë°©ì†¡íšŸìˆ˜"])}</div></div>
    <div class="kpi"><div class="label">íŠ¹ì•½íšŸìˆ˜</div><div class="value">${fmtNumber(d["íŠ¹ì•½íšŸìˆ˜"])}</div></div>
    <div class="kpi"><div class="label">í‰ê· ë‹¬ì„±ìœ¨</div><div class="value">${fmtPercent01(d["í‰ê· ë‹¬ì„±ìœ¨"])}</div></div>
    <div class="kpi"><div class="label">ì‹œê°„ë‹¹ë§¤ì¶œ</div><div class="value">${fmtNumber(d["ì‹œê°„ë‹¹ë§¤ì¶œ"])}</div></div>
  `;
}

/*** Charts ***/
let charts = {};
function drawBarChart(canvasId, labels, values01, labelText){
  const ctx = document.getElementById(canvasId);
  if(charts[canvasId]) charts[canvasId].destroy();

  charts[canvasId] = new Chart(ctx, {
    type:"bar",
    data:{
      labels: labels || [],
      datasets:[{
        label: labelText,
        data: (values01 || []).map(v => Number(v) * 100)
      }]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      scales:{ y:{ beginAtZero:true } }
    }
  });
}

/*** ë°ì´í„° ë¡œë“œ (í•„í„° ë°˜ì˜) ***/
async function loadOptions(){
  // optionsëŠ” í•„í„° ì—†ì´ë„ ë˜ì§€ë§Œ, â€œí•„í„°ëœ ì˜µì…˜â€ì„ ì›í•˜ë©´ query ë¶™ì—¬ë„ ë¨
  const d = await jsonp(API_URL + "?action=options");
  if(d && d.error) throw new Error(d.error);

  // ì˜µì…˜ì´ ì—†ì„ ë•Œë„ ì•ˆì „í•˜ê²Œ
  renderSlicer("slicerYears", "ì—°ë„", "years", d.years || []);
  renderSlicer("slicerMonths", "ì›”", "months", d.months || []);
  renderSlicer("slicerDows", "ìš”ì¼", "dows", d.dows || []);
  renderSlicer("slicerItems", "ì•„ì´í…œ", "items", d.items || []);
  renderSlicer("slicerChannels", "ë°©ì†¡ì±„ë„", "channels", d.channels || []);
}

async function loadSummary(){
  const q = buildQueryFromState();
  const d = await jsonp(API_URL + "?action=summary" + (q ? "&" + q : ""));
  if(d && d.error) throw new Error(d.error);
  renderKpis(d);
}

async function loadCharts(){
  const q = buildQueryFromState();
  const suffix = q ? "&" + q : "";

  const ch = await jsonp(API_URL + "?action=bar&by=ë°©ì†¡ì±„ë„&metric=ë‹¬ì„±ìœ¨&agg=mean&top=30" + suffix);
  if(ch && ch.error) throw new Error(ch.error);
  drawBarChart("channelChart", ch.labels, ch.values, "ë‹¬ì„±ìœ¨(%)");

  const it = await jsonp(API_URL + "?action=bar&by=ì•„ì´í…œ&metric=ë‹¬ì„±ìœ¨&agg=mean&top=30" + suffix);
  if(it && it.error) throw new Error(it.error);
  drawBarChart("itemChart", it.labels, it.values, "ë‹¬ì„±ìœ¨(%)");

  const mo = await jsonp(API_URL + "?action=bar&by=ì›”&metric=ë‹¬ì„±ìœ¨&agg=mean&top=12" + suffix);
  if(mo && mo.error) throw new Error(mo.error);
  drawBarChart("monthChart", mo.labels, mo.values, "ë‹¬ì„±ìœ¨(%)");

  const dw = await jsonp(API_URL + "?action=bar&by=ìš”ì¼&metric=ë‹¬ì„±ìœ¨&agg=mean&top=7" + suffix);
  if(dw && dw.error) throw new Error(dw.error);
  drawBarChart("dowChart", dw.labels, dw.values, "ë‹¬ì„±ìœ¨(%)");
}

async function refreshAll(){
  try{
    setStatus(true, "ë¡œë”© ì¤‘â€¦");
    writeStateToUrl();
    await loadSummary();
    await loadCharts();
    updateTimestamp();
    setStatus(true, "ì •ìƒ", "í•„í„° ì ìš© ì™„ë£Œ");
  }catch(err){
    console.error(err);
    setStatus(false, "ì˜¤ë¥˜", err.message || String(err));
  }
}

/*** ì´ë²¤íŠ¸: ì¹© í´ë¦­/ì „ì²´ì„ íƒ/í•´ì œ ***/
document.addEventListener("click", async (ev) => {
  const chip = ev.target.closest(".chip");
  if(chip){
    const key = chip.dataset.key;
    const val = chip.dataset.val;
    if(state[key].has(val)) state[key].delete(val);
    else state[key].add(val);

    // UI ì¦‰ì‹œ ë°˜ì˜
    chip.classList.toggle("on");

    // KPI/ì°¨íŠ¸ ì¦‰ì‹œ ê°±ì‹  (ì—‘ì…€ ìŠ¬ë¼ì´ì„œ ëŠë‚Œ)
    await refreshAll();
    return;
  }

  const actionBtn = ev.target.closest("button[data-action]");
  if(actionBtn){
    const key = actionBtn.dataset.key;
    const action = actionBtn.dataset.action;
    const parent = actionBtn.closest(".slicer");
    const chipEls = parent ? parent.querySelectorAll(`.chip[data-key="${key}"]`) : [];

    if(action === "none"){
      state[key].clear();
      chipEls.forEach(c=>c.classList.remove("on"));
      await refreshAll();
    }
    if(action === "all"){
      chipEls.forEach(c=>state[key].add(c.dataset.val));
      chipEls.forEach(c=>c.classList.add("on"));
      await refreshAll();
    }
  }
});

document.getElementById("resetBtn").addEventListener("click", async ()=>{
  ["years","months","dows","items","channels"].forEach(k=>state[k].clear());
  await loadOptions(); // UI ë‹¤ì‹œ ê·¸ë¦¼
  await refreshAll();
});

document.getElementById("refreshBtn").addEventListener("click", async ()=>{
  await refreshAll();
});

/*** ì´ˆê¸° ì‹¤í–‰ ***/
(async function init(){
  readStateFromUrl();
  await loadOptions();   // ìŠ¬ë¼ì´ì„œ ì˜µì…˜ ìƒì„±
  await refreshAll();    // í˜„ì¬ ì„ íƒê°’ìœ¼ë¡œ KPI/ì°¨íŠ¸ ë¡œë“œ
})();
</script>
</body>
</html>
