<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ë°©ì†¡ ë§¤ì¶œ ëŒ€ì‹œë³´ë“œ</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root{
      --bg:#f5f7fb; --card:#fff; --line:#e7ecf5; --text:#111827; --muted:#6b7280;
      --primary:#2563eb;
    }
    body{ margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", Arial; background:var(--bg); color:var(--text); }
    header{ padding:18px 18px 8px; }
    h1{ margin:0; font-size:22px; display:flex; gap:10px; align-items:center; }
    .sub{ margin-top:6px; color:var(--muted); font-size:12px; }
    .topbar{ margin: 10px 18px 0; background:var(--card); border:1px solid var(--line); border-radius:12px; padding:10px 12px; display:flex; justify-content:space-between; align-items:center; gap:10px;}
    .status{ font-size:13px; color:var(--muted); }
    .actions{ display:flex; gap:8px; align-items:center; }
    button{ border:1px solid var(--line); background:#fff; border-radius:10px; padding:8px 10px; cursor:pointer; }
    button.primary{ background:#e8efff; border-color:#cfe0ff; color:#1d4ed8; font-weight:600; }
    .wrap{ display:grid; grid-template-columns: 300px 1fr; gap:14px; padding: 12px 18px 24px; }
    .card{ background:var(--card); border:1px solid var(--line); border-radius:14px; box-shadow: 0 1px 8px rgba(0,0,0,.03); }
    .filters{ padding:12px; }
    .filters h3{ margin:0 0 10px; font-size:14px; }
    .filterBlock{ margin-bottom:12px; padding-bottom:12px; border-bottom:1px dashed var(--line); }
    .filterHead{ display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;}
    .filterTitle{ font-weight:700; font-size:13px; }
    .miniBtns{ display:flex; gap:6px; }
    .miniBtns button{ padding:6px 8px; font-size:12px; border-radius:9px; }
    .pills{ display:flex; flex-wrap:wrap; gap:6px; }
    .pill{ padding:7px 9px; border:1px solid var(--line); border-radius:999px; font-size:12px; background:#fff; cursor:pointer; user-select:none; }
    .pill.on{ background:#e8efff; border-color:#cfe0ff; color:#1d4ed8; font-weight:700; }
    .grid{ display:grid; gap:14px; }
    .kpis{ display:grid; grid-template-columns: repeat(6, minmax(140px, 1fr)); gap:10px; padding:12px; }
    .kpi{ background:#eaf3ff; border-radius:14px; padding:12px; }
    .kpi .t{ font-size:12px; color:#334155; }
    .kpi .v{ margin-top:4px; font-size:20px; font-weight:800; }
    .charts{ padding:12px; display:grid; grid-template-columns: 1fr 1fr; gap:14px; }
    .chartCard{ padding:12px; }
    .chartTitle{ font-weight:800; font-size:14px; margin-bottom:8px; }
    canvas{ width:100% !important; height:260px !important; }
    .full{ grid-column: 1 / -1; }
    .note{ padding:0 12px 12px; color:var(--muted); font-size:12px; }
    @media (max-width:1100px){
      .wrap{ grid-template-columns: 1fr; }
      .kpis{ grid-template-columns: repeat(2, minmax(140px, 1fr)); }
      .charts{ grid-template-columns: 1fr; }
      canvas{ height:280px !important; }
    }
  </style>
</head>
<body>
<header>
  <h1>ğŸ“Š ë°©ì†¡ ë§¤ì¶œ ëŒ€ì‹œë³´ë“œ</h1>
  <div class="sub">ì—‘ì…€ ìŠ¬ë¼ì´ì„œì²˜ëŸ¼ ì„ íƒí•˜ë©´ KPI/ì°¨íŠ¸ê°€ ì¦‰ì‹œ ë³€ê²½ë©ë‹ˆë‹¤.</div>
</header>

<div class="topbar card">
  <div class="status" id="status">ìƒíƒœ: ëŒ€ê¸°</div>
  <div class="actions">
    <div class="status" id="updated"></div>
    <button id="btnReset">ì „ì²´ í•´ì œ</button>
    <button class="primary" id="btnRefresh">ìƒˆë¡œê³ ì¹¨</button>
  </div>
</div>

<div class="wrap">
  <!-- Filters -->
  <div class="card filters">
    <h3>í•„í„°(ìŠ¬ë¼ì´ì„œ)</h3>

    <div class="filterBlock">
      <div class="filterHead">
        <div class="filterTitle">ì—°ë„</div>
        <div class="miniBtns">
          <button data-all="years">ì „ì²´</button>
          <button data-clear="years">í•´ì œ</button>
        </div>
      </div>
      <div class="pills" id="years"></div>
    </div>

    <div class="filterBlock">
      <div class="filterHead">
        <div class="filterTitle">ì›”</div>
        <div class="miniBtns">
          <button data-all="months">ì „ì²´</button>
          <button data-clear="months">í•´ì œ</button>
        </div>
      </div>
      <div class="pills" id="months"></div>
    </div>

    <div class="filterBlock">
      <div class="filterHead">
        <div class="filterTitle">ì¼</div>
        <div class="miniBtns">
          <button data-all="days">ì „ì²´</button>
          <button data-clear="days">í•´ì œ</button>
        </div>
      </div>
      <div class="pills" id="days"></div>
    </div>

    <div class="filterBlock">
      <div class="filterHead">
        <div class="filterTitle">ìš”ì¼</div>
        <div class="miniBtns">
          <button data-all="dows">ì „ì²´</button>
          <button data-clear="dows">í•´ì œ</button>
        </div>
      </div>
      <div class="pills" id="dows"></div>
    </div>

    <div class="filterBlock">
      <div class="filterHead">
        <div class="filterTitle">ì•„ì´í…œ</div>
        <div class="miniBtns">
          <button data-all="items">ì „ì²´</button>
          <button data-clear="items">í•´ì œ</button>
        </div>
      </div>
      <div class="pills" id="items"></div>
    </div>

    <div class="filterBlock" style="border-bottom:none;padding-bottom:0;margin-bottom:0;">
      <div class="filterHead">
        <div class="filterTitle">ë°©ì†¡ì±„ë„</div>
        <div class="miniBtns">
          <button data-all="channels">ì „ì²´</button>
          <button data-clear="channels">í•´ì œ</button>
        </div>
      </div>
      <div class="pills" id="channels"></div>
      <div class="note">â€» í‚¤ë¥¼ ëª¨ë¥´ë©´ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>
    </div>
  </div>

  <!-- Main -->
  <div class="grid">
    <!-- KPI -->
    <div class="card">
      <div class="kpis">
        <div class="kpi"><div class="t">ë°©ì†¡íšŸìˆ˜</div><div class="v" id="k_bcnt">-</div></div>
        <div class="kpi"><div class="t">íŠ¹ì•½íšŸìˆ˜</div><div class="v" id="k_scnt">-</div></div>
        <div class="kpi"><div class="t">íŠ¹ì•½ë¹„ìš©</div><div class="v" id="k_scost">-</div></div>
        <div class="kpi"><div class="t">í‰ê· ë‹¬ì„±ìœ¨</div><div class="v" id="k_ach">-</div></div>
        <div class="kpi"><div class="t">ë°©ì†¡ì‹œê°„(ë¶„)</div><div class="v" id="k_time">-</div></div>
        <div class="kpi"><div class="t">ì‹œê°„ë‹¹ë§¤ì¶œ</div><div class="v" id="k_hr">-</div></div>
      </div>
    </div>

    <!-- Charts -->
    <div class="card charts">
      <div class="card chartCard">
        <div class="chartTitle">ë°©ì†¡ì±„ë„ë³„ (ëª©í‘œ/ì‹¤ì /ë‹¬ì„±ìœ¨)</div>
        <canvas id="ch_channel"></canvas>
      </div>
      <div class="card chartCard">
        <div class="chartTitle">ì›”ë³„ (ëª©í‘œ/ì‹¤ì /ë‹¬ì„±ìœ¨)</div>
        <canvas id="ch_month"></canvas>
      </div>

      <div class="card chartCard">
        <div class="chartTitle">ìš”ì¼ë³„ (ëª©í‘œ/ì‹¤ì /ë‹¬ì„±ìœ¨)</div>
        <canvas id="ch_dow"></canvas>
      </div>
      <div class="card chartCard">
        <div class="chartTitle">ì¼ìë³„ (ëª©í‘œ/ì‹¤ì /ë‹¬ì„±ìœ¨) - TOP 30</div>
        <canvas id="ch_dateTop"></canvas>
      </div>

      <div class="card chartCard full">
        <div class="chartTitle">ì•„ì´í…œë³„ (ëª©í‘œ/ì‹¤ì /ë‹¬ì„±ìœ¨)</div>
        <canvas id="ch_item"></canvas>
      </div>
    </div>
  </div>
</div>

<script>
/** =========================
 * âœ… ì—¬ê¸° 2ê°œë§Œ ë°”ê¾¸ë©´ ë¨
 * ========================= */
const API_URL = "https://script.google.com/macros/s/AKfycbzpLQ2wcNZIuisAjsaDTxA_Lj1E5X6CWEeZffW0_PPdjHTAo7peoHig1UmzyvXbkLHUuw/exec"; // .../exec
const API_KEY = "WHHS-PSM-221035"; // Code.gsì˜ DASH_KEYì™€ ë™ì¼

/** ========================= */
const nf = new Intl.NumberFormat('ko-KR');
const state = {
  selected: { years:new Set(), months:new Set(), days:new Set(), dows:new Set(), items:new Set(), channels:new Set() },
  options:  { years:[], months:[], days:[], dows:[], items:[], channels:[] },
  charts: {}
};

function setStatus(text){ document.getElementById('status').textContent = text; }
function setUpdated(text){ document.getElementById('updated').textContent = text ? `ì—…ë°ì´íŠ¸: ${text}` : ''; }

function jsonp(url){
  return new Promise((resolve, reject)=>{
    const cb = "cb_" + Math.random().toString(36).slice(2);
    const script = document.createElement('script');
    const sep = url.includes('?') ? '&' : '?';
    const full = url + sep + "callback=" + cb;

    let timer = setTimeout(()=>{
      cleanup();
      reject(new Error("JSONP timeout"));
    }, 15000);

    function cleanup(){
      clearTimeout(timer);
      if (script.parentNode) script.parentNode.removeChild(script);
      try{ delete window[cb]; }catch(e){ window[cb]=undefined; }
    }

    window[cb] = (data)=>{
      cleanup();
      resolve(data);
    };

    script.onerror = ()=>{
      cleanup();
      reject(new Error("JSONP load failed"));
    };
    script.src = full;
    document.body.appendChild(script);
  });
}

function buildQuery(){
  const p = new URLSearchParams();
  p.set("action","dashboard");
  p.set("key", API_KEY);

  for (const k of ["years","months","days","dows","items","channels"]){
    const arr = [...state.selected[k]];
    if (arr.length) p.set(k, arr.join(','));
  }
  return p.toString();
}

async function loadDashboard(){
  setStatus("ìƒíƒœ: ë¡œë”© ì¤‘...");
  try{
    const url = API_URL + "?" + buildQuery();
    const data = await jsonp(url);

    if (!data || data.ok !== true){
      if (data && data.error === 'unauthorized'){
        setStatus("ìƒíƒœ: ì˜¤ë¥˜ - í‚¤ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤");
      } else {
        setStatus("ìƒíƒœ: ì˜¤ë¥˜ - ë°ì´í„° í˜•ì‹ ë¬¸ì œ");
      }
      return;
    }

    setUpdated(data.updated || "");
    state.options = data.options || state.options;

    renderFilters();
    renderKpis(data.kpis || {});
    renderCharts(data.charts || {});
    setStatus("ìƒíƒœ: ì •ìƒ Â· í•„í„° ì ìš© ì™„ë£Œ");
  }catch(err){
    console.error(err);
    setStatus("ìƒíƒœ: ì˜¤ë¥˜ Â· JSONP load failed");
  }
}

function fmtMoney(n){
  return nf.format(Math.round(Number(n)||0));
}
function fmtPct(n){
  // âœ… ë°±ì—”ë“œì—ì„œ ì´ë¯¸ % ê°’(ì˜ˆ: 82.35)ì„ ì¤Œ. ì†Œìˆ˜ 0~1ë¡œ ë³€í™˜ ê¸ˆì§€
  const v = Number(n)||0;
  return `${Math.round(v)}%`;
}

function renderKpis(k){
  document.getElementById('k_bcnt').textContent  = fmtMoney(k.ë°©ì†¡íšŸìˆ˜);
  document.getElementById('k_scnt').textContent  = fmtMoney(k.íŠ¹ì•½íšŸìˆ˜);
  document.getElementById('k_scost').textContent = fmtMoney(k.íŠ¹ì•½ë¹„ìš©);
  document.getElementById('k_ach').textContent   = fmtPct(k.í‰ê· ë‹¬ì„±ìœ¨);
  document.getElementById('k_time').textContent  = fmtMoney(k.ë°©ì†¡ì‹œê°„_ë¶„);
  document.getElementById('k_hr').textContent    = fmtMoney(k.ì‹œê°„ë‹¹ë§¤ì¶œ);
}

/** ========= Filters ========= */
function makePills(containerId, values, key){
  const box = document.getElementById(containerId);
  box.innerHTML = "";
  values.forEach(v=>{
    const pill = document.createElement('div');
    pill.className = "pill" + (state.selected[key].has(v) ? " on" : "");
    pill.textContent = v;
    pill.onclick = ()=>{
      if (state.selected[key].has(v)) state.selected[key].delete(v);
      else state.selected[key].add(v);
      loadDashboard(); // ì¦‰ì‹œ ë°˜ì˜
    };
    box.appendChild(pill);
  });
}

function renderFilters(){
  // ì›”/ì¼ì€ ìˆ«ì ì •ë ¬ëœ optionsê°€ ë°±ì—”ë“œì—ì„œ ë‚´ë ¤ì˜´
  makePills("years", state.options.years || [], "years");
  makePills("months", state.options.months || [], "months");
  makePills("days", state.options.days || [], "days");
  makePills("dows", state.options.dows || [], "dows");
  makePills("items", state.options.items || [], "items");
  makePills("channels", state.options.channels || [], "channels");
}

// ì „ì²´/í•´ì œ ë²„íŠ¼
document.querySelectorAll("[data-all]").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    const k = btn.getAttribute("data-all");
    (state.options[k]||[]).forEach(v=> state.selected[k].add(v));
    loadDashboard();
  });
});
document.querySelectorAll("[data-clear]").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    const k = btn.getAttribute("data-clear");
    state.selected[k].clear();
    loadDashboard();
  });
});
document.getElementById("btnReset").onclick = ()=>{
  for (const k of Object.keys(state.selected)) state.selected[k].clear();
  loadDashboard();
};
document.getElementById("btnRefresh").onclick = ()=> loadDashboard();

/** ========= Charts =========
 * - ëª©í‘œ/ì‹¤ì : bar
 * - ë‹¬ì„±ìœ¨: ì„  ì—°ê²° X (scatter ì ë§Œ) + ì  í¬ê²Œ
 */
function buildComboChart(ctx, labels, goal, actual, ach, opts={}){
  const achPoints = ach.map((v,i)=>({ x: labels[i], y: v }));

  return new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [
        { label:'ëª©í‘œ', data: goal, yAxisID:'y', order: 2 },
        { label:'ì‹¤ì ', data: actual, yAxisID:'y', order: 2 },
        {
          type:'scatter',
          label:'ë‹¬ì„±ìœ¨(%)',
          data: achPoints,
          yAxisID:'pct',
          showLine: false,          // âœ… ì„  ì—°ê²° X
          pointRadius: 7,           // âœ… ì  í¬ê²Œ
          pointHoverRadius: 9,
          order: 1
        }
      ]
    },
    options: {
      responsive:true,
      maintainAspectRatio:false,
      plugins:{
        tooltip:{
          callbacks:{
            label: (c)=>{
              if (c.dataset.type === 'scatter'){
                return `ë‹¬ì„±ìœ¨: ${Math.round(c.raw.y)}%`;
              }
              return `${c.dataset.label}: ${fmtMoney(c.raw)}`;
            }
          }
        },
        legend:{ position:'top' }
      },
      scales:{
        y:{
          beginAtZero:true,
          ticks:{ callback:(v)=> fmtMoney(v) }
        },
        pct:{
          position:'right',
          beginAtZero:true,
          grid:{ drawOnChartArea:false },
          ticks:{ callback:(v)=> `${v}%` },
          suggestedMax: opts.suggestedMaxPct || 200
        },
        x:{
          ticks:{ autoSkip: true, maxRotation: 45, minRotation: 0 }
        }
      }
    }
  });
}

function buildComboChartHorizontal(ctx, labels, goal, actual, ach){
  // ìˆ˜í‰ bar + scatter
  const achPoints = ach.map((v,i)=>({ y: labels[i], x: v }));

  return new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [
        { label:'ëª©í‘œ', data: goal, indexAxis:'y', yAxisID:'y', order: 2 },
        { label:'ì‹¤ì ', data: actual, indexAxis:'y', yAxisID:'y', order: 2 },
        {
          type:'scatter',
          label:'ë‹¬ì„±ìœ¨(%)',
          data: achPoints,
          xAxisID:'pct',
          yAxisID:'x',
          showLine:false,
          pointRadius:7,
          pointHoverRadius:9,
          order: 1
        }
      ]
    },
    options: {
      responsive:true,
      maintainAspectRatio:false,
      plugins:{
        tooltip:{
          callbacks:{
            label:(c)=>{
              if (c.dataset.type === 'scatter'){
                return `ë‹¬ì„±ìœ¨: ${Math.round(c.raw.x)}%`;
              }
              return `${c.dataset.label}: ${fmtMoney(c.raw)}`;
            }
          }
        },
        legend:{ position:'top' }
      },
      indexAxis:'y',
      scales:{
        y:{ beginAtZero:true, ticks:{ callback:(v)=> fmtMoney(v) } },
        pct:{
          position:'top',
          beginAtZero:true,
          grid:{ drawOnChartArea:false },
          ticks:{ callback:(v)=> `${v}%` },
          suggestedMax: 200
        }
      }
    }
  });
}

function destroyIf(chart){
  if (chart) chart.destroy();
}

function renderCharts(ch){
  // ë°©ì†¡ì±„ë„ë³„: ë¬¸ìì—´ ë‚´ë¦¼ì°¨ìˆœ, (ë¹„ì–´ìˆìŒ) ë°±ì—”ë“œì—ì„œ ì´ë¯¸ ì œì™¸
  destroyIf(state.charts.channel);
  state.charts.channel = buildComboChart(
    document.getElementById("ch_channel"),
    ch.channel.labels, ch.channel.goal, ch.channel.actual, ch.channel.ach,
    { suggestedMaxPct: 250 }
  );

  // ì›”ë³„
  destroyIf(state.charts.month);
  state.charts.month = buildComboChart(
    document.getElementById("ch_month"),
    ch.month.labels, ch.month.goal, ch.month.actual, ch.month.ach,
    { suggestedMaxPct: 200 }
  );

  // ìš”ì¼ë³„
  destroyIf(state.charts.dow);
  state.charts.dow = buildComboChart(
    document.getElementById("ch_dow"),
    ch.dow.labels, ch.dow.goal, ch.dow.actual, ch.dow.ach,
    { suggestedMaxPct: 200 }
  );

  // ì¼ìë³„ TOP30: ìˆ˜í‰ìœ¼ë¡œ ê°€ë…ì„±
  destroyIf(state.charts.dateTop);
  state.charts.dateTop = buildComboChartHorizontal(
    document.getElementById("ch_dateTop"),
    ch.dateTop.labels, ch.dateTop.goal, ch.dateTop.actual, ch.dateTop.ach
  );

  // ì•„ì´í…œë³„: ì„¸ë¡œë§‰ëŒ€ + scatter(ì )
  destroyIf(state.charts.item);
  state.charts.item = buildComboChart(
    document.getElementById("ch_item"),
    ch.item.labels, ch.item.goal, ch.item.actual, ch.item.ach,
    { suggestedMaxPct: 200 }
  );
}

/** ====== Start ====== */
(async function init(){
  // í‚¤ íŒì—… ë°©ì‹ì€ ë¸Œë¼ìš°ì €ì—ì„œë§Œ ê°€ëŠ¥í•˜ê³  "ë³´ì•ˆ"ì€ ì•½í•´ìš”.
  // ê·¸ë˜ë„ ì›í•˜ì…¨ìœ¼ë‹ˆ: ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì— í‚¤ ì €ì¥ â†’ API í˜¸ì¶œ ì‹œ key íŒŒë¼ë¯¸í„°ë¡œ ì „ë‹¬.
  // (ì´ë¯¸ API_KEY ìƒìˆ˜ë¡œ ë„£ëŠ” ë°©ì‹ì´ë¼ë©´ íŒì—…ì€ ìƒëµ ê°€ëŠ¥)

  if (!API_URL.includes("script.google.com/macros/s/") || API_URL.includes("PASTE_")){
    setStatus("ìƒíƒœ: ì„¤ì • í•„ìš” - API_URLì„ index.html ìƒë‹¨ì— ì…ë ¥í•˜ì„¸ìš”");
    return;
  }
  if (API_KEY === "CHANGE_ME_TO_YOUR_KEY"){
    setStatus("ìƒíƒœ: ì„¤ì • í•„ìš” - API_KEYë¥¼ index.html ìƒë‹¨ì— ì…ë ¥í•˜ì„¸ìš”");
    return;
  }
  await loadDashboard();
})();
</script>
</body>
</html>
