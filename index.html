<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ë°©ì†¡ ë§¤ì¶œ ëŒ€ì‹œë³´ë“œ</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg:#f6f8fc;
      --card:#ffffff;
      --line:#e8eef7;
      --text:#0f172a;
      --muted:#64748b;
      --shadow: 0 10px 24px rgba(15,23,42,.08);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", sans-serif;
      background:var(--bg); color:var(--text);
    }
    header{
      padding:22px 26px 10px;
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
    }
    .title{
      display:flex; align-items:center; gap:10px;
      font-size:28px; font-weight:900;
    }
    .subtitle{color:var(--muted); font-size:13px; margin-top:6px}
    .topbar{
      margin:0 26px 18px;
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      padding:12px 14px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .status{font-size:14px}
    .status b{color:#0b5}
    .btns{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    button{
      border:1px solid var(--line); background:#fff; color:#111827;
      border-radius:12px; padding:8px 12px; font-weight:700; cursor:pointer;
    }
    button.primary{background:#eef3ff; border-color:#dbe7ff}
    .wrap{
      padding:0 26px 26px;
      display:grid;
      grid-template-columns: 320px 1fr;
      gap:18px;
      align-items:start;
    }
    .panel{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      padding:14px;
    }
    .panel h3{
      margin:0 0 10px;
      font-size:14px; letter-spacing:-.2px;
    }
    .filters .group{margin:10px 0 14px}
    .group-head{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom:8px;
    }
    .group-title{font-weight:900}
    .mini-btn{
      padding:6px 10px; border-radius:10px; font-size:12px; font-weight:800;
      background:#fff;
    }
    .chips{display:flex; flex-wrap:wrap; gap:8px}
    .chip{
      padding:7px 10px; border-radius:999px;
      border:1px solid var(--line);
      background:#fff; font-weight:800; font-size:12px;
      cursor:pointer; user-select:none;
    }
    .chip.on{background:#eef3ff; border-color:#cfe0ff}
    .hint{color:var(--muted); font-size:12px; margin-top:8px}

    .main{
      display:grid;
      grid-template-rows: auto auto;
      gap:14px;
    }
    .kpis{
      display:grid;
      grid-template-columns: repeat(6, minmax(0,1fr));
      gap:10px;
    }
    .kpi{
      background:#eef5ff;
      border-radius:16px;
      padding:12px 12px;
      min-height:72px;
    }
    .kpi .k{color:var(--muted); font-size:12px; font-weight:800}
    .kpi .v{font-size:20px; font-weight:1000; margin-top:6px}

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
    }
    .chart-card{padding:14px}
    .chart-title{font-weight:1000; margin:0 0 10px}
    canvas{width:100%; height:280px}

    .full{grid-column:1/-1}
    .modal{
      position:fixed; inset:0; background:rgba(15,23,42,.45);
      display:none; align-items:center; justify-content:center; padding:18px;
    }
    .modal.on{display:flex}
    .modal .box{
      width:100%; max-width:420px;
      background:#fff; border-radius:18px; padding:16px; border:1px solid var(--line);
      box-shadow: var(--shadow);
    }
    .modal h4{margin:0 0 10px; font-weight:1000}
    .row{display:flex; gap:10px}
    input{
      flex:1;
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px 12px;
      font-size:14px;
    }
    .footnote{color:var(--muted); font-size:12px; margin-top:8px}

    @media (max-width: 1100px){
      .wrap{grid-template-columns:1fr}
      .kpis{grid-template-columns: repeat(2,minmax(0,1fr))}
      .grid{grid-template-columns:1fr}
      canvas{height:300px}
    }
  </style>
</head>

<body>
  <header>
    <div>
      <div class="title">ğŸ“Š ë°©ì†¡ ë§¤ì¶œ ëŒ€ì‹œë³´ë“œ</div>
      <div class="subtitle">ì—‘ì…€ ìŠ¬ë¼ì´ì„œì²˜ëŸ¼ ì„ íƒí•˜ë©´ KPI/ì°¨íŠ¸ê°€ ì¦‰ì‹œ ë³€ê²½ë©ë‹ˆë‹¤.</div>
    </div>
  </header>

  <div class="topbar">
    <div class="status" id="status">ìƒíƒœ: <b>ëŒ€ê¸°</b></div>
    <div class="btns">
      <div style="color:var(--muted); font-size:12px" id="updated"></div>
      <button id="btnReset">ì „ì²´ í•´ì œ</button>
      <button class="primary" id="btnRefresh">ìƒˆë¡œê³ ì¹¨</button>
      <button id="btnKey">í‚¤ ë³€ê²½</button>
    </div>
  </div>

  <div class="wrap">
    <aside class="panel filters">
      <h3>í•„í„°(ìŠ¬ë¼ì´ì„œ)</h3>

      <div class="group" data-key="years">
        <div class="group-head">
          <div class="group-title">ì—°ë„</div>
          <div>
            <button class="mini-btn" data-act="all" data-key="years">ì „ì²´</button>
            <button class="mini-btn" data-act="clear" data-key="years">í•´ì œ</button>
          </div>
        </div>
        <div class="chips" id="chips-years"></div>
      </div>

      <div class="group" data-key="months">
        <div class="group-head">
          <div class="group-title">ì›”</div>
          <div>
            <button class="mini-btn" data-act="all" data-key="months">ì „ì²´</button>
            <button class="mini-btn" data-act="clear" data-key="months">í•´ì œ</button>
          </div>
        </div>
        <div class="chips" id="chips-months"></div>
      </div>

      <div class="group" data-key="days">
        <div class="group-head">
          <div class="group-title">ì¼</div>
          <div>
            <button class="mini-btn" data-act="all" data-key="days">ì „ì²´</button>
            <button class="mini-btn" data-act="clear" data-key="days">í•´ì œ</button>
          </div>
        </div>
        <div class="chips" id="chips-days"></div>
      </div>

      <div class="group" data-key="dows">
        <div class="group-head">
          <div class="group-title">ìš”ì¼</div>
          <div>
            <button class="mini-btn" data-act="all" data-key="dows">ì „ì²´</button>
            <button class="mini-btn" data-act="clear" data-key="dows">í•´ì œ</button>
          </div>
        </div>
        <div class="chips" id="chips-dows"></div>
      </div>

      <div class="group" data-key="items">
        <div class="group-head">
          <div class="group-title">ì•„ì´í…œ</div>
          <div>
            <button class="mini-btn" data-act="all" data-key="items">ì „ì²´</button>
            <button class="mini-btn" data-act="clear" data-key="items">í•´ì œ</button>
          </div>
        </div>
        <div class="chips" id="chips-items"></div>
      </div>

      <div class="group" data-key="channels">
        <div class="group-head">
          <div class="group-title">ë°©ì†¡ì±„ë„</div>
          <div>
            <button class="mini-btn" data-act="all" data-key="channels">ì „ì²´</button>
            <button class="mini-btn" data-act="clear" data-key="channels">í•´ì œ</button>
          </div>
        </div>
        <div class="chips" id="chips-channels"></div>
      </div>

      <div class="hint">â€» í‚¤ë¥¼ ëª¨ë¥´ë©´ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>
    </aside>

    <main class="main">
      <section class="kpis" id="kpis"></section>

      <section class="grid">
        <div class="panel chart-card">
          <div class="chart-title">ë°©ì†¡ì±„ë„ë³„ (ëª©í‘œ/ì‹¤ì /ë‹¬ì„±ìœ¨)</div>
          <canvas id="ch-channel"></canvas>
        </div>
        <div class="panel chart-card">
          <div class="chart-title">ì›”ë³„ (ëª©í‘œ/ì‹¤ì /ë‹¬ì„±ìœ¨)</div>
          <canvas id="ch-month"></canvas>
        </div>
        <div class="panel chart-card">
          <div class="chart-title">ìš”ì¼ë³„ (ëª©í‘œ/ì‹¤ì /ë‹¬ì„±ìœ¨)</div>
          <canvas id="ch-dow"></canvas>
        </div>
        <div class="panel chart-card">
          <div class="chart-title">ì¼ìë³„ (ëª©í‘œ/ì‹¤ì /ë‹¬ì„±ìœ¨) - TOP 30</div>
          <canvas id="ch-date"></canvas>
        </div>
        <div class="panel chart-card full">
          <div class="chart-title">ì•„ì´í…œë³„ (ëª©í‘œ/ì‹¤ì /ë‹¬ì„±ìœ¨)</div>
          <canvas id="ch-item"></canvas>
        </div>
      </section>
    </main>
  </div>

  <!-- Key Modal -->
  <div class="modal" id="modal">
    <div class="box">
      <h4>í‚¤ ì…ë ¥</h4>
      <div class="row">
        <input id="keyInput" placeholder="í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”" />
        <button class="primary" id="keySave">í™•ì¸</button>
      </div>
      <div class="footnote">í‚¤ëŠ” ë¸Œë¼ìš°ì €(localStorage)ì—ë§Œ ì €ì¥ë©ë‹ˆë‹¤.</div>
    </div>
  </div>

<script>
/*** âœ… ì—¬ê¸°ë§Œ ë³¸ì¸ ê°’ìœ¼ë¡œ ë³€ê²½ ***/
const API_URL = "https://script.google.com/macros/s/AKfycbzpLQ2wcNZIuisAjsaDTxA_Lj1E5X6CWEeZffW0_PPdjHTAo7peoHig1UmzyvXbkLHUuw/exec"; // ì˜ˆ: https://script.google.com/macros/s/XXXX/exec
const DEFAULT_KEY = "WHHS-PSM-221035"; // ë¹ˆì¹¸ ê¶Œì¥(ì‚¬ìš©ìê°€ íŒì—…ì—ì„œ ì…ë ¥)

/*** ìƒíƒœ/ì „ì—­ ***/
const state = {
  key: localStorage.getItem("dash_key") || DEFAULT_KEY,
  filters: { years:[], months:[], days:[], dows:[], items:[], channels:[] },
  options: null,
  charts: {},
  chartInstances: {}
};

const fmtNum = (n) => {
  const x = Number(n||0);
  return x.toLocaleString(undefined,{maximumFractionDigits:2});
};
const fmtPct = (n) => `${(Number(n||0)).toFixed(1)}%`;

/*** JSONP ***/
function jsonp(url){
  return new Promise((resolve,reject)=>{
    const cb = "CB_" + Math.random().toString(36).slice(2);
    const script = document.createElement("script");
    const sep = url.includes("?") ? "&" : "?";
    script.src = url + sep + "callback=" + cb;
    script.onerror = () => { cleanup(); reject(new Error("JSONP load failed")); };
    window[cb] = (data) => { cleanup(); resolve(data); };

    function cleanup(){
      delete window[cb];
      script.remove();
    }
    document.body.appendChild(script);
  });
}

/*** ìš”ì²­ URL êµ¬ì„± ***/
function buildUrl(){
  const p = new URLSearchParams();
  p.set("action","dashboard");
  p.set("key", state.key || "");
  // filters
  for (const k of Object.keys(state.filters)){
    if (state.filters[k] && state.filters[k].length){
      p.set(k, state.filters[k].join(","));
    }
  }
  return API_URL + (API_URL.includes("?") ? "&" : "?") + p.toString();
}

/*** ë¡œë“œ ***/
async function load(){
  setStatus("ë¡œë”© ì¤‘...", "warn");
  try{
    const data = await jsonp(buildUrl());
    if (!data.ok){
      setStatus("ì˜¤ë¥˜ Â· " + (data.message || data.error || "unknown"), "bad");
      return;
    }

    state.options = data.options;
    state.charts = data.charts;

    document.getElementById("updated").textContent = "ì—…ë°ì´íŠ¸: " + (data.updated || "");

    renderOptions();
    renderKpis(data.kpis);
    renderCharts();

    setStatus("ì •ìƒ Â· í•„í„° ì ìš© ì™„ë£Œ", "good");
  }catch(err){
    console.error(err);
    setStatus("ì˜¤ë¥˜ Â· JSONP load failed", "bad");
  }
}

function setStatus(text, kind){
  const el = document.getElementById("status");
  const color = kind==="good" ? "#0b5" : kind==="bad" ? "#e11d48" : "#f59e0b";
  el.innerHTML = `ìƒíƒœ: <b style="color:${color}">${text}</b>`;
}

/*** KPI ***/
function renderKpis(k){
  const box = document.getElementById("kpis");
  const items = [
    ["ë°©ì†¡íšŸìˆ˜", fmtNum(k.ë°©ì†¡íšŸìˆ˜)],
    ["íŠ¹ì•½íšŸìˆ˜", fmtNum(k.íŠ¹ì•½íšŸìˆ˜)],
    ["íŠ¹ì•½ë¹„ìš©", fmtNum(k.íŠ¹ì•½ë¹„ìš©)],
    ["í‰ê· ë‹¬ì„±ìœ¨", fmtPct(k.í‰ê· ë‹¬ì„±ìœ¨)],
    ["ë°©ì†¡ì‹œê°„(ë¶„)", fmtNum(k.ë°©ì†¡ì‹œê°„_ë¶„)],
    ["ì‹œê°„ë‹¹ë§¤ì¶œ", fmtNum(k.ì‹œê°„ë‹¹ë§¤ì¶œ)]
  ];
  box.innerHTML = items.map(([kk,v])=>`
    <div class="kpi">
      <div class="k">${kk}</div>
      <div class="v">${v}</div>
    </div>
  `).join("");
}

/*** ìŠ¬ë¼ì´ì„œ ì˜µì…˜ ë Œë”ë§ ***/
function renderOptions(){
  if (!state.options) return;
  renderChips("years", state.options.years, (a,b)=>Number(a)-Number(b));
  renderChips("months", state.options.months, (a,b)=>Number(a)-Number(b));
  renderChips("days", state.options.days, (a,b)=>Number(a)-Number(b));
  renderChips("dows", state.options.dows, (a,b)=>["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "].indexOf(a)-["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "].indexOf(b));
  renderChips("items", state.options.items, (a,b)=>String(a).localeCompare(String(b)));
  renderChips("channels", state.options.channels, (a,b)=>String(a).localeCompare(String(b)));
}

function renderChips(key, list, sorter){
  const el = document.getElementById("chips-"+key);
  const arr = [...(list||[])].sort(sorter);
  el.innerHTML = arr.map(v=>{
    const on = state.filters[key].includes(v);
    return `<span class="chip ${on?"on":""}" data-k="${key}" data-v="${escapeHtml(v)}">${escapeHtml(v)}</span>`;
  }).join("");
}

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

/*** ìŠ¬ë¼ì´ì„œ í´ë¦­ ì²˜ë¦¬ ***/
document.addEventListener("click", (e)=>{
  const chip = e.target.closest(".chip");
  if (chip){
    const k = chip.dataset.k;
    const v = chip.dataset.v;
    toggleFilter(k, v);
    load();
    return;
  }
  const mini = e.target.closest(".mini-btn");
  if (mini){
    const act = mini.dataset.act;
    const k = mini.dataset.key;
    if (act==="all"){
      state.filters[k] = (state.options?.[k] || []).slice();
    } else {
      state.filters[k] = [];
    }
    load();
    return;
  }
});

function toggleFilter(k, v){
  const arr = state.filters[k];
  const i = arr.indexOf(v);
  if (i>=0) arr.splice(i,1);
  else arr.push(v);
}

/*** ë²„íŠ¼ ***/
document.getElementById("btnReset").onclick = ()=>{
  for (const k of Object.keys(state.filters)) state.filters[k]=[];
  load();
};
document.getElementById("btnRefresh").onclick = ()=> load();
document.getElementById("btnKey").onclick = ()=> openKeyModal();

/*** í‚¤ ëª¨ë‹¬ ***/
const modal = document.getElementById("modal");
function openKeyModal(){
  modal.classList.add("on");
  document.getElementById("keyInput").value = state.key || "";
  document.getElementById("keyInput").focus();
}
modal.addEventListener("click",(e)=>{
  if (e.target === modal) modal.classList.remove("on");
});
document.getElementById("keySave").onclick = ()=>{
  const v = document.getElementById("keyInput").value.trim();
  state.key = v;
  localStorage.setItem("dash_key", v);
  modal.classList.remove("on");
  load();
};

/*** ì°¨íŠ¸ ê³µí†µ ì˜µì…˜
 *  - ë‹¬ì„±ìœ¨(â—)ì´ "í•­ìƒ ìœ„"ë¡œ ë³´ì´ë„ë¡:
 *    - ë‹¬ì„±ìœ¨ ë°ì´í„°ì…‹ì„ ë§ˆì§€ë§‰(ë§¨ ë’¤) + ë†’ì€ order
 *    - pointHitRadius í¬ê²Œ, hoverRadius í¬ê²Œ
 */
function baseChartOptions(){
  return {
    responsive:true,
    maintainAspectRatio:false,
    interaction: { mode:"nearest", intersect:false },
    plugins:{
      legend:{ position:"top" },
      tooltip:{
        callbacks:{
          label: (ctx)=>{
            const ds = ctx.dataset;
            const v = ctx.parsed?.y ?? ctx.parsed ?? 0;

            // ë‹¬ì„±ìœ¨(%) íˆ´íŒì— ë°©ì†¡íšŸìˆ˜ ê°™ì´
            if (ds._kind === "rate"){
              const idx = ctx.dataIndex;
              const n = ds._count?.[idx] ?? 0;
              return `ë‹¬ì„±ìœ¨: ${fmtPct(v)}  |  ë°©ì†¡íšŸìˆ˜: ${fmtNum(n)}`;
            }
            if (ds._kind === "goal") return `ëª©í‘œ: ${fmtNum(v)}`;
            if (ds._kind === "actual") return `ì‹¤ì : ${fmtNum(v)}`;
            return `${ds.label}: ${fmtNum(v)}`;
          }
        }
      }
    },
    scales:{
      y:{ beginAtZero:true },
      y1:{
        beginAtZero:true,
        position:"right",
        grid:{ drawOnChartArea:false },
        ticks:{
          callback:(v)=> `${v}%`
        }
      }
    }
  };
}

/*** ì°¨íŠ¸ ìƒì„±/ê°±ì‹  ***/
function renderCharts(){
  drawCombo("ch-channel", state.charts.channel, { rateAsLine:false }); // ì±„ë„: ì (ì„ X)
  drawCombo("ch-month",   state.charts.month,   { rateAsLine:true  }); // ì›”ë³„: ì„ ê·¸ë˜í”„
  drawCombo("ch-dow",     state.charts.dow,     { rateAsLine:true  }); // ìš”ì¼ë³„: ì„ ê·¸ë˜í”„
  drawCombo("ch-date",    state.charts.date,    { rateAsLine:true, horizontal:true }); // ì¼ìë³„: ì„ ê·¸ë˜í”„ + ê°€ë…ì„± ìœ„í•´ ê°€ë¡œì¶• ìœ ì§€
  drawCombo("ch-item",    state.charts.item,    { rateAsLine:false }); // ì•„ì´í…œ: ì (ì„ X)
}

/**
 * ëª©í‘œ/ì‹¤ì  = í•©ê³„ ë§‰ëŒ€
 * ë‹¬ì„±ìœ¨ = ì  ë˜ëŠ” ì„ (ìš”ì²­)
 * + ë‹¬ì„±ìœ¨ datasetì„ ë§ˆì§€ë§‰ì— ë‘¬ì„œ "í•­ìƒ ìœ„ë¡œ"
 */
function drawCombo(canvasId, data, opt){
  opt = opt || {};
  const el = document.getElementById(canvasId);
  const labels = data?.labels || [];
  const goal = data?.goal || [];
  const actual = data?.actual || [];
  const rate = data?.rate || [];
  const count = data?.count || [];

  const isHorizontal = !!opt.horizontal;

  // ê¸°ì¡´ ì°¨íŠ¸ íŒŒê¸°
  if (state.chartInstances[canvasId]){
    state.chartInstances[canvasId].destroy();
  }

  const cfg = {
    type: isHorizontal ? "bar" : "bar",
    data: {
      labels,
      datasets: [
        {
          label:"ëª©í‘œ",
          data: goal,
          yAxisID:"y",
          _kind:"goal",
          order: 1,
          borderWidth:0
        },
        {
          label:"ì‹¤ì ",
          data: actual,
          yAxisID:"y",
          _kind:"actual",
          order: 2,
          borderWidth:0
        },

        // âœ… ë‹¬ì„±ìœ¨: ë§ˆì§€ë§‰ì— ë°°ì¹˜(order í¬ê²Œ) => í•­ìƒ ìœ„
        {
          label:"ë‹¬ì„±ìœ¨(%)",
          data: rate,
          yAxisID:"y1",
          _kind:"rate",
          _count: count,
          type: "line",                    // ì„ /ì 
          showLine: !!opt.rateAsLine,       // ì›”/ìš”ì¼/ì¼ìë§Œ ì„ 
          tension: 0.25,
          order: 99,
          pointStyle: "circle",
          pointRadius: 5,                  // ì  í¬ê¸°(ìš”ì²­: ì¡°ê¸ˆ ì¤„ì—¬ë„ OK)
          pointHoverRadius: 10,            // âœ… hover í¬ê²Œ
          pointHitRadius: 16,              // âœ… ì¡íˆëŠ” ë²”ìœ„ í¬ê²Œ
          borderWidth: 2
        }
      ]
    },
    options: baseChartOptions()
  };

  // ê°€ë¡œë§‰ëŒ€ ì˜µì…˜(ì¼ì TOP30)
  if (isHorizontal){
    cfg.options.indexAxis = "y";
  }

  state.chartInstances[canvasId] = new Chart(el, cfg);
}

/*** ì‹œì‘: í‚¤ê°€ ì—†ìœ¼ë©´ íŒì—…ë¶€í„° ***/
(function init(){
  if (!state.key){
    openKeyModal();
    setStatus("í‚¤ ì…ë ¥ í•„ìš”", "warn");
  } else {
    load();
  }
})();
</script>
</body>
</html>
