<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ë°©ì†¡ ë§¤ì¶œ ëŒ€ì‹œë³´ë“œ</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg:#f5f7fb;
      --card:#ffffff;
      --line:#e7edf5;
      --text:#0f172a;
      --muted:#64748b;
      --primary:#2563eb;
      --danger:#dc2626;
      --pill:#eef2ff;
      --shadow: 0 6px 20px rgba(15,23,42,.06);
      --radius:14px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR",sans-serif}
    .wrap{max-width:1400px;margin:18px auto;padding:0 14px}
    .top{
      display:flex;align-items:flex-start;justify-content:space-between;gap:12px;margin-bottom:10px
    }
    h1{margin:0;font-size:26px;display:flex;gap:10px;align-items:center}
    .sub{margin-top:4px;color:var(--muted);font-size:12px}
    .statusbar{
      background:var(--card);border:1px solid var(--line);border-radius:12px;
      padding:10px 12px;display:flex;align-items:center;justify-content:space-between;gap:10px;
      box-shadow:var(--shadow);margin:10px 0 12px
    }
    .statusleft{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .badge{padding:4px 8px;border-radius:999px;background:#ecfeff;color:#155e75;font-weight:700;font-size:12px}
    .badge.err{background:#fef2f2;color:#991b1b}
    .btns{display:flex;gap:8px;align-items:center}
    button{
      border:1px solid var(--line);background:var(--card);padding:7px 10px;border-radius:10px;
      cursor:pointer;font-weight:700
    }
    button.primary{background:var(--primary);border-color:var(--primary);color:white}
    button.danger{background:#fff;border-color:#fecaca;color:var(--danger)}
    button:disabled{opacity:.55;cursor:not-allowed}

    .grid{
      display:grid;
      grid-template-columns: 300px 1fr;
      gap:12px;
      align-items:start;
    }
    @media (max-width: 1080px){
      .grid{grid-template-columns:1fr}
    }

    .card{
      background:var(--card);border:1px solid var(--line);border-radius:var(--radius);
      box-shadow:var(--shadow);
    }
    .filters{padding:12px}
    .filters h2{margin:0 0 8px;font-size:15px}
    .group{margin:10px 0 14px}
    .ghead{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:8px}
    .gtitle{font-weight:900}
    .gactions{display:flex;gap:6px}
    .mini{padding:5px 8px;font-size:12px;border-radius:9px}
    .pills{display:flex;flex-wrap:wrap;gap:6px}
    .pill{
      padding:7px 9px;border-radius:999px;border:1px solid var(--line);
      background:#fff;cursor:pointer;user-select:none;
      font-weight:700;font-size:12px
    }
    .pill.on{
      background:var(--pill);
      border-color:#c7d2fe;
      outline: 2px solid #dbeafe;
    }

    .main{display:grid;gap:12px}
    .kpis{display:grid;grid-template-columns: repeat(6, 1fr);gap:10px;padding:12px}
    @media (max-width: 1080px){
      .kpis{grid-template-columns: repeat(2, 1fr)}
    }
    .kpi{background:#eaf2ff;border:1px solid #dbeafe;border-radius:14px;padding:12px}
    .kpi .t{color:var(--muted);font-weight:900;font-size:12px}
    .kpi .v{font-size:20px;font-weight:1000;margin-top:3px}

    .charts{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      padding:12px;
    }
    @media (max-width: 1080px){
      .charts{grid-template-columns:1fr}
    }
    .chartcard{padding:10px 12px}
    .charttitle{font-weight:1000;margin:0 0 8px;font-size:14px}
    .canvasWrap{height:280px}
    .canvasWrap.tall{height:320px}
    .canvasWrap.hbar{height:320px}
    .footnote{color:var(--muted);font-size:12px;padding:0 12px 12px}

    /* key modal */
    .modalBack{
      position:fixed;inset:0;background:rgba(15,23,42,.55);
      display:flex;align-items:center;justify-content:center;padding:18px;
      z-index:9999;
    }
    .modal{
      width:min(520px, 95vw);
      background:var(--card);border:1px solid var(--line);border-radius:16px;
      box-shadow: 0 25px 80px rgba(0,0,0,.25);
      padding:16px;
    }
    .modal h3{margin:0 0 6px;font-size:18px}
    .modal p{margin:0 0 12px;color:var(--muted);font-size:13px}
    .row{display:flex;gap:8px}
    input{
      flex:1;border:1px solid var(--line);border-radius:12px;padding:10px 12px;
      font-weight:800
    }
    .help{margin-top:10px;color:var(--muted);font-size:12px}
    .errtxt{color:var(--danger);font-weight:900;margin-top:8px;display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div>
        <h1>ğŸ“Š ë°©ì†¡ ë§¤ì¶œ ëŒ€ì‹œë³´ë“œ</h1>
        <div class="sub">ì—‘ì…€ ìŠ¬ë¼ì´ì„œì²˜ëŸ¼ ì„ íƒí•˜ë©´ KPI/ì°¨íŠ¸ê°€ ì¦‰ì‹œ ë³€ê²½ë©ë‹ˆë‹¤.</div>
      </div>
    </div>

    <div class="statusbar card">
      <div class="statusleft">
        <span id="badge" class="badge">ìƒíƒœ: ì¤€ë¹„</span>
        <span id="statusText" style="color:var(--muted);font-weight:800">í‚¤ ì¸ì¦ í›„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.</span>
      </div>
      <div class="btns">
        <span id="updatedAt" style="color:var(--muted);font-weight:800"></span>
        <button id="btnClear" class="danger" disabled>ì „ì²´ í•´ì œ</button>
        <button id="btnRefresh" class="primary" disabled>ìƒˆë¡œê³ ì¹¨</button>
      </div>
    </div>

    <div class="grid">
      <div class="card filters">
        <h2>í•„í„°(ìŠ¬ë¼ì´ì„œ)</h2>

        <div class="group" data-group="years">
          <div class="ghead">
            <div class="gtitle">ì—°ë„</div>
            <div class="gactions">
              <button class="mini" data-act="all">ì „ì²´</button>
              <button class="mini" data-act="clear">í•´ì œ</button>
            </div>
          </div>
          <div class="pills" id="pills-years"></div>
        </div>

        <div class="group" data-group="months">
          <div class="ghead">
            <div class="gtitle">ì›”</div>
            <div class="gactions">
              <button class="mini" data-act="all">ì „ì²´</button>
              <button class="mini" data-act="clear">í•´ì œ</button>
            </div>
          </div>
          <div class="pills" id="pills-months"></div>
        </div>

        <div class="group" data-group="days">
          <div class="ghead">
            <div class="gtitle">ì¼</div>
            <div class="gactions">
              <button class="mini" data-act="all">ì „ì²´</button>
              <button class="mini" data-act="clear">í•´ì œ</button>
            </div>
          </div>
          <div class="pills" id="pills-days"></div>
        </div>

        <div class="group" data-group="dows">
          <div class="ghead">
            <div class="gtitle">ìš”ì¼</div>
            <div class="gactions">
              <button class="mini" data-act="all">ì „ì²´</button>
              <button class="mini" data-act="clear">í•´ì œ</button>
            </div>
          </div>
          <div class="pills" id="pills-dows"></div>
        </div>

        <div class="group" data-group="items">
          <div class="ghead">
            <div class="gtitle">ì•„ì´í…œ</div>
            <div class="gactions">
              <button class="mini" data-act="all">ì „ì²´</button>
              <button class="mini" data-act="clear">í•´ì œ</button>
            </div>
          </div>
          <div class="pills" id="pills-items"></div>
        </div>

        <div class="group" data-group="channels">
          <div class="ghead">
            <div class="gtitle">ë°©ì†¡ì±„ë„</div>
            <div class="gactions">
              <button class="mini" data-act="all">ì „ì²´</button>
              <button class="mini" data-act="clear">í•´ì œ</button>
            </div>
          </div>
          <div class="pills" id="pills-channels"></div>
        </div>
      </div>

      <div class="main">
        <div class="card kpis" id="kpis">
          <div class="kpi"><div class="t">ë°©ì†¡íšŸìˆ˜</div><div class="v" id="kpi-bc">-</div></div>
          <div class="kpi"><div class="t">íŠ¹ì•½íšŸìˆ˜</div><div class="v" id="kpi-spc">-</div></div>
          <div class="kpi"><div class="t">íŠ¹ì•½ë¹„ìš©</div><div class="v" id="kpi-spv">-</div></div>
          <div class="kpi"><div class="t">í‰ê· ë‹¬ì„±ìœ¨</div><div class="v" id="kpi-ach">-</div></div>
          <div class="kpi"><div class="t">ë°©ì†¡ì‹œê°„(ë¶„)</div><div class="v" id="kpi-min">-</div></div>
          <div class="kpi"><div class="t">ì‹œê°„ë‹¹ë§¤ì¶œ</div><div class="v" id="kpi-hr">-</div></div>
        </div>

        <div class="card charts">
          <div class="card chartcard">
            <div class="charttitle">ë°©ì†¡ì±„ë„ë³„ (ëª©í‘œ/ì‹¤ì /ë‹¬ì„±ìœ¨)</div>
            <div class="canvasWrap tall"><canvas id="chartChannel"></canvas></div>
          </div>
          <div class="card chartcard">
            <div class="charttitle">ì›”ë³„ (ëª©í‘œ/ì‹¤ì /ë‹¬ì„±ìœ¨)</div>
            <div class="canvasWrap"><canvas id="chartMonth"></canvas></div>
          </div>
          <div class="card chartcard">
            <div class="charttitle">ìš”ì¼ë³„ (ëª©í‘œ/ì‹¤ì /ë‹¬ì„±ìœ¨)</div>
            <div class="canvasWrap"><canvas id="chartDow"></canvas></div>
          </div>
          <div class="card chartcard">
            <div class="charttitle">ì¼ìë³„ (ëª©í‘œ/ì‹¤ì /ë‹¬ì„±ìœ¨) - TOP 30</div>
            <div class="canvasWrap hbar"><canvas id="chartDay"></canvas></div>
          </div>
          <div class="card chartcard" style="grid-column:1/-1">
            <div class="charttitle">ì•„ì´í…œë³„ (ëª©í‘œ/ì‹¤ì /ë‹¬ì„±ìœ¨)</div>
            <div class="canvasWrap tall"><canvas id="chartItem"></canvas></div>
          </div>
        </div>
        <div class="footnote">â€» ë‹¬ì„±ìœ¨(%) ì ì€ ì„ ì„ ì‡ì§€ ì•Šê³  í¬ê²Œ í‘œì‹œí•©ë‹ˆë‹¤. (ë¹„ì–´ìˆìŒ/aaa ë“± ë¶ˆí•„ìš” ê°’ì€ ìë™ ì œì™¸)</div>
      </div>
    </div>
  </div>

  <!-- Key Modal -->
  <div class="modalBack" id="keyModal" style="display:none">
    <div class="modal">
      <h3>í‚¤ ì¸ì¦</h3>
      <p>ì´ ëŒ€ì‹œë³´ë“œëŠ” ë¹„ê³µê°œ í‚¤ë¥¼ ì•„ëŠ” ì‚¬ëŒë§Œ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. í‚¤ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.</p>
      <div class="row">
        <input id="keyInput" placeholder="í‚¤ ì…ë ¥" />
        <button class="primary" id="keyBtn">í™•ì¸</button>
      </div>
      <div class="errtxt" id="keyErr">í‚¤ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.</div>
      <div class="help">íŒ: í‚¤ëŠ” ë¸Œë¼ìš°ì €ì— ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤(ë‹¤ìŒ ì ‘ì† ì‹œ ìë™).</div>
    </div>
  </div>

  <script>
    /********************************************************
     * 1) ì—¬ê¸°ë§Œ ì„¤ì •í•˜ë©´ ë©ë‹ˆë‹¤
     ********************************************************/
    const SCRIPT_EXEC_URL = "https://script.google.com/macros/s/AKfycbzpLQ2wcNZIuisAjsaDTxA_Lj1E5X6CWEeZffW0_PPdjHTAo7peoHig1UmzyvXbkLHUuw/exec"; // âœ… ë„ˆì˜ /exec URLë¡œ êµì²´

    /********************************************************
     * ë‚´ë¶€ ìƒíƒœ
     ********************************************************/
    let AUTH_KEY = "";
    const filters = {
      years: new Set(),
      months: new Set(),
      days: new Set(),
      dows: new Set(),
      items: new Set(),
      channels: new Set()
    };
    let optionsCache = null;

    // charts
    let chChannel, chMonth, chDow, chDay, chItem;

    const badge = document.getElementById('badge');
    const statusText = document.getElementById('statusText');
    const updatedAt = document.getElementById('updatedAt');
    const btnRefresh = document.getElementById('btnRefresh');
    const btnClear = document.getElementById('btnClear');

    function setStatus(ok, text){
      badge.className = "badge" + (ok ? "" : " err");
      badge.textContent = ok ? "ìƒíƒœ: ì •ìƒ" : "ìƒíƒœ: ì˜¤ë¥˜";
      statusText.textContent = text || "";
    }

    function nowText(){
      const d = new Date();
      return `ì—…ë°ì´íŠ¸: ${d.getFullYear()}. ${d.getMonth()+1}. ${d.getDate()}. ${d.toLocaleTimeString('ko-KR')}`;
    }

    function fmtInt(n){
      n = Number(n||0);
      return n.toLocaleString('ko-KR');
    }
    function fmtMoney(n){
      n = Number(n||0);
      return n.toLocaleString('ko-KR');
    }
    function fmtPct(x){
      x = Number(x||0);
      return (x*100).toFixed(0) + "%";
    }

    /********************************************************
     * JSONP í˜¸ì¶œ (GitHub Pagesì—ì„œ CORS íšŒí”¼)
     ********************************************************/
    function jsonp(url){
      return new Promise((resolve, reject)=>{
        const cb = "CB_" + Math.random().toString(16).slice(2);
        window[cb] = (data)=>{
          delete window[cb];
          script.remove();
          resolve(data);
        };
        const script = document.createElement("script");
        script.src = url + (url.includes("?") ? "&" : "?") + "callback=" + cb;
        script.onerror = ()=>{
          delete window[cb];
          script.remove();
          reject(new Error("JSONP load failed"));
        };
        document.body.appendChild(script);
      });
    }

    function buildUrl(action, extraParams={}){
      const params = new URLSearchParams();
      params.set("action", action);
      params.set("key", AUTH_KEY);

      // filters -> query
      for (const k of Object.keys(filters)){
        if (filters[k].size){
          params.set(k, Array.from(filters[k]).join(","));
        }
      }
      for (const [k,v] of Object.entries(extraParams)){
        params.set(k, v);
      }

      return SCRIPT_EXEC_URL + "?" + params.toString();
    }

    /********************************************************
     * í‚¤ ì¸ì¦ ëª¨ë‹¬
     ********************************************************/
    const keyModal = document.getElementById('keyModal');
    const keyInput = document.getElementById('keyInput');
    const keyBtn = document.getElementById('keyBtn');
    const keyErr = document.getElementById('keyErr');

    function openKeyModal(){
      keyModal.style.display = "flex";
      keyErr.style.display = "none";
      keyInput.value = "";
      keyInput.focus();
    }
    function closeKeyModal(){
      keyModal.style.display = "none";
    }

    async function verifyKey(key){
      AUTH_KEY = key.trim();
      // options í˜¸ì¶œë¡œ ê²€ì¦ (í‚¤ í‹€ë¦¬ë©´ {error:'UNAUTHORIZED'} ì‘ë‹µ)
      const url = SCRIPT_EXEC_URL + `?action=options&key=${encodeURIComponent(AUTH_KEY)}`;
      const data = await jsonp(url);
      if (data && data.error === "UNAUTHORIZED") return null;
      return data;
    }

    async function onKeySubmit(){
      try{
        keyBtn.disabled = true;
        const key = keyInput.value.trim();
        const data = await verifyKey(key);
        if(!data){
          keyErr.style.display = "block";
          setStatus(false, "í‚¤ ì¸ì¦ ì‹¤íŒ¨");
          return;
        }
        // success
        localStorage.setItem("WHHS_DASH_KEY", key);
        optionsCache = data;
        closeKeyModal();
        btnRefresh.disabled = false;
        btnClear.disabled = false;

        setStatus(true, "í•„í„° ì˜µì…˜ ë¡œë“œ ì™„ë£Œ");
        renderOptions(optionsCache);
        await loadDashboard();
      }catch(err){
        setStatus(false, err.message || String(err));
      }finally{
        keyBtn.disabled = false;
      }
    }

    keyBtn.addEventListener("click", onKeySubmit);
    keyInput.addEventListener("keydown", (e)=>{
      if(e.key === "Enter") onKeySubmit();
    });

    /********************************************************
     * ì˜µì…˜(ìŠ¬ë¼ì´ì„œ) ë Œë”ë§
     ********************************************************/
    function renderPills(containerId, arr, key){
      const el = document.getElementById(containerId);
      el.innerHTML = "";
      arr.forEach(v=>{
        const pill = document.createElement("div");
        pill.className = "pill";
        pill.textContent = v;
        pill.onclick = ()=>{
          if(filters[key].has(v)) filters[key].delete(v);
          else filters[key].add(v);
          pill.classList.toggle("on");
          loadDashboard();
        };
        el.appendChild(pill);
      });
    }

    function renderOptions(opt){
      // ì´ë¯¸ Apps Scriptì—ì„œ ì •ë ¬/í•„í„°(aaa ì œê±°, ì›”/ìš”ì¼ ìˆœì„œ) ì²˜ë¦¬ë¨
      renderPills("pills-years", opt.years || [], "years");
      renderPills("pills-months", opt.months || [], "months");
      renderPills("pills-days", opt.days || [], "days");
      renderPills("pills-dows", opt.dows || [], "dows");
      renderPills("pills-items", opt.items || [], "items");
      renderPills("pills-channels", opt.channels || [], "channels");
    }

    // ê·¸ë£¹ ë²„íŠ¼ (ì „ì²´/í•´ì œ)
    document.querySelectorAll(".group .mini").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const group = btn.closest(".group").dataset.group;
        const act = btn.dataset.act;
        const pillsEl = document.getElementById("pills-" + group);
        if(!optionsCache) return;

        const allArr = optionsCache[group] || [];

        if(act === "all"){
          filters[group] = new Set(allArr);
          pillsEl.querySelectorAll(".pill").forEach(p=>p.classList.add("on"));
        }else{
          filters[group].clear();
          pillsEl.querySelectorAll(".pill").forEach(p=>p.classList.remove("on"));
        }
        loadDashboard();
      });
    });

    btnClear.addEventListener("click", ()=>{
      for(const k of Object.keys(filters)) filters[k].clear();
      document.querySelectorAll(".pill.on").forEach(p=>p.classList.remove("on"));
      loadDashboard();
    });

    btnRefresh.addEventListener("click", ()=>{
      loadDashboard(true);
    });

    /********************************************************
     * ëŒ€ì‹œë³´ë“œ ë¡œë”©
     ********************************************************/
    async function loadDashboard(force){
      try{
        setStatus(true, "ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...");
        updatedAt.textContent = "";
        const url = buildUrl("dashboard");
        const d = await jsonp(url);

        if(d && d.error){
          setStatus(false, d.message || d.error);
          return;
        }

        renderKpis(d.summary || {});
        renderCharts(d);

        updatedAt.textContent = nowText();
        setStatus(true, "í•„í„° ì ìš© ì™„ë£Œ");
      }catch(err){
        setStatus(false, err.message || "JSONP load failed");
      }
    }

    function renderKpis(s){
      document.getElementById("kpi-bc").textContent = fmtInt(s.ë°©ì†¡íšŸìˆ˜);
      document.getElementById("kpi-spc").textContent = fmtInt(s.íŠ¹ì•½íšŸìˆ˜);
      document.getElementById("kpi-spv").textContent = fmtMoney(s.íŠ¹ì•½ë¹„ìš©);
      document.getElementById("kpi-ach").textContent = fmtPct(s.í‰ê· ë‹¬ì„±ìœ¨);
      document.getElementById("kpi-min").textContent = fmtInt(s.ë°©ì†¡ì‹œê°„_ë¶„);
      document.getElementById("kpi-hr").textContent = fmtMoney(s.ì‹œê°„ë‹¹ë§¤ì¶œ);
    }

    /********************************************************
     * ì°¨íŠ¸ ìœ í‹¸
     * - ëª©í‘œ/ì‹¤ì : ë§‰ëŒ€
     * - ë‹¬ì„±ìœ¨: "ì "ë§Œ(ì„  ì—°ê²° X) + ì  í¬ê²Œ
     ********************************************************/
    function makeComboChart(ctx, labels, goals, actuals, achs, horizontal=false){
      const achPct = (achs||[]).map(x=>Number(x||0)*100);

      const data = {
        labels,
        datasets: [
          {
            label: "ëª©í‘œ",
            data: goals,
            type: "bar",
            yAxisID: horizontal ? "x" : "y",
            borderWidth: 0
          },
          {
            label: "ì‹¤ì ",
            data: actuals,
            type: "bar",
            yAxisID: horizontal ? "x" : "y",
            borderWidth: 0
          },
          {
            label: "ë‹¬ì„±ìœ¨(%)",
            data: achPct,
            type: "scatter",        // âœ… ì„  ì—°ê²° ì—†ìŒ
            yAxisID: horizontal ? "y2" : "y2",
            pointRadius: 6,         // âœ… ì  í¬ê²Œ
            pointHoverRadius: 7
          }
        ]
      };

      const options = {
        responsive:true,
        maintainAspectRatio:false,
        plugins:{
          legend:{ position:"top" },
          tooltip:{
            callbacks:{
              label:(ctx)=>{
                const label = ctx.dataset.label || "";
                const v = ctx.parsed[horizontal ? "x" : "y"];
                if(label.includes("ë‹¬ì„±ìœ¨")) return `${label}: ${Number(v).toFixed(0)}%`;
                return `${label}: ${fmtMoney(v)}`;
              }
            }
          }
        },
        scales: horizontal ? {
          x: { beginAtZero:true, grid:{color:"rgba(100,116,139,.15)"} },
          y: { grid:{display:false} },
          y2: { position:"right", beginAtZero:true, grid:{display:false}, ticks:{ callback:(v)=>v+"%" } }
        } : {
          y: { beginAtZero:true, grid:{color:"rgba(100,116,139,.15)"} },
          x: { grid:{display:false} },
          y2: { position:"right", beginAtZero:true, grid:{display:false}, ticks:{ callback:(v)=>v+"%" } }
        }
      };

      if(horizontal){
        // ê°€ë¡œ ë§‰ëŒ€í˜•: Chart.jsëŠ” indexAxisë¡œ ì²˜ë¦¬
        options.indexAxis = "y";
      }

      return { data, options };
    }

    function buildOrUpdate(chartRef, canvasId, cfg){
      const ctx = document.getElementById(canvasId);
      if(chartRef) chartRef.destroy();
      return new Chart(ctx, cfg);
    }

    function renderCharts(d){
      // ë°©ì†¡ì±„ë„: ë¬¸ìì—´ ë‚´ë¦¼ì°¨ìˆœ + (ë¹„ì–´ìˆìŒ ì œê±°)ëŠ” ì„œë²„ì—ì„œ ì²˜ë¦¬ë¨
      const c = d.channel || {labels:[],goals:[],actuals:[],achs:[]};
      const m = d.month || {labels:[],goals:[],actuals:[],achs:[]};
      const w = d.dow || {labels:[],goals:[],actuals:[],achs:[]};
      const day = d.day || {labels:[],goals:[],actuals:[],achs:[]};
      const it = d.item || {labels:[],goals:[],actuals:[],achs:[]};

      // 1) ë°©ì†¡ì±„ë„: ì„¸ë¡œë§‰ëŒ€ + ë‹¬ì„±ìœ¨ ì (ì„  ì—†ìŒ)
      {
        const {data, options} = makeComboChart(null, c.labels, c.goals, c.actuals, c.achs, false);
        chChannel = buildOrUpdate(chChannel, "chartChannel", { type:"bar", data, options });
      }

      // 2) ì›”ë³„: ì„¸ë¡œë§‰ëŒ€ + ë‹¬ì„±ìœ¨ ì 
      {
        const {data, options} = makeComboChart(null, m.labels, m.goals, m.actuals, m.achs, false);
        chMonth = buildOrUpdate(chMonth, "chartMonth", { type:"bar", data, options });
      }

      // 3) ìš”ì¼ë³„: ì„¸ë¡œë§‰ëŒ€ + ë‹¬ì„±ìœ¨ ì 
      {
        const {data, options} = makeComboChart(null, w.labels, w.goals, w.actuals, w.achs, false);
        chDow = buildOrUpdate(chDow, "chartDow", { type:"bar", data, options });
      }

      // 4) ì¼ìë³„: ê°€ë¡œë§‰ëŒ€ + ë‹¬ì„±ìœ¨ ì 
      {
        const {data, options} = makeComboChart(null, day.labels, day.goals, day.actuals, day.achs, true);
        chDay = buildOrUpdate(chDay, "chartDay", { type:"bar", data, options });
      }

      // 5) ì•„ì´í…œë³„: âœ… ì„¸ë¡œë§‰ëŒ€ + ë‹¬ì„±ìœ¨ ì (ì„  ì—†ìŒ)
      {
        const {data, options} = makeComboChart(null, it.labels, it.goals, it.actuals, it.achs, false);
        chItem = buildOrUpdate(chItem, "chartItem", { type:"bar", data, options });
      }
    }

    /********************************************************
     * ì‹œì‘
     ********************************************************/
    (async function init(){
      // 1) localStorageì— í‚¤ê°€ ìˆìœ¼ë©´ ë°”ë¡œ ì‹œë„
      const saved = localStorage.getItem("WHHS_DASH_KEY");
      if(saved){
        try{
          setStatus(true, "ì €ì¥ëœ í‚¤ë¡œ ì¸ì¦ ì¤‘...");
          const data = await verifyKey(saved);
          if(!data) throw new Error("saved key invalid");
          optionsCache = data;
          btnRefresh.disabled = false;
          btnClear.disabled = false;
          setStatus(true, "í•„í„° ì˜µì…˜ ë¡œë“œ ì™„ë£Œ");
          renderOptions(optionsCache);
          await loadDashboard();
          return;
        }catch(e){
          localStorage.removeItem("WHHS_DASH_KEY");
        }
      }
      // 2) ì—†ê±°ë‚˜ ì‹¤íŒ¨í•˜ë©´ íŒì—…
      openKeyModal();
      setStatus(false, "í‚¤ ì¸ì¦ í•„ìš”");
    })();
  </script>
</body>
</html>
