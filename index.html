<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ë°©ì†¡ ë§¤ì¶œ ëŒ€ì‹œë³´ë“œ</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg:#f5f7fb; --card:#fff; --line:#e6ebf4; --text:#111827; --muted:#6b7280;
      --radius:14px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:1280px;margin:18px auto;padding:0 14px}
    .topbar{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;margin-bottom:12px}
    .title{display:flex;gap:10px;align-items:center}
    .title h1{font-size:28px;margin:0}
    .title p{margin:6px 0 0;color:var(--muted);font-size:13px}

    .btn{border:1px solid var(--line);background:#fff;border-radius:10px;padding:9px 12px;cursor:pointer}
    .btn.primary{border-color:#b8ccff;background:#eaf1ff}
    .pill{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--line);background:#fff;border-radius:999px;padding:7px 10px;color:var(--muted);font-size:13px}

    .grid{display:grid;grid-template-columns:320px 1fr;gap:14px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:0 8px 24px rgba(17,24,39,.04)}
    .card .hd{padding:14px 14px 0}
    .card .bd{padding:14px}

    .filters .sec{margin-bottom:14px}
    .filters .sec h3{margin:0 0 8px;font-size:14px}
    .chips{display:flex;flex-wrap:wrap;gap:8px}
    .chip{border:1px solid var(--line);background:#fff;border-radius:999px;padding:8px 10px;font-size:12px;cursor:pointer;user-select:none}
    .chip.on{border-color:#7aa3ff;background:#eaf1ff}
    .filters .sec .tools{display:flex;gap:8px;margin-left:auto}
    .filters .sec .row{display:flex;align-items:center;justify-content:space-between;gap:10px}

    .kpis{display:grid;grid-template-columns:repeat(6,1fr);gap:10px}
    .kpi{background:#eaf1ff;border-radius:14px;padding:14px}
    .kpi .k{font-size:12px;color:#475569}
    .kpi .v{font-size:22px;font-weight:800;margin-top:6px}

    .charts{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:14px;
      align-items:stretch;
    }
    .charts .span2{grid-column:1 / -1}

    /* âœ… ì°¨íŠ¸ê°€ ë¬´í•œíˆ ê¸¸ì–´ì§€ëŠ” í˜„ìƒ ë°©ì§€ í•µì‹¬:
       - chartBoxì— ê³ ì • ë†’ì´(í˜¹ì€ min-height) ì£¼ê¸°
       - overflow hidden
       - canvasëŠ” ë¶€ëª¨ì— 100%ë¡œ ë§ì¶”ê³  Chart.jsëŠ” maintainAspectRatio:false
    */
    .chartBox{
      position:relative;
      height:320px;
      min-height:320px;
      overflow:hidden;
    }
    .chartBox.tall{height:360px;min-height:360px}
    .chartBox.short{height:280px;min-height:280px}
    canvas{width:100% !important;height:100% !important;display:block}

    .status{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px}
    .status .left{display:flex;gap:10px;align-items:center}

    @media (max-width: 1100px){
      .grid{grid-template-columns:1fr}
      .kpis{grid-template-columns:repeat(2,1fr)}
      .charts{grid-template-columns:1fr}
      .charts .span2{grid-column:auto}
      .chartBox,.chartBox.tall,.chartBox.short{height:320px;min-height:320px}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="title">
        <div style="font-size:28px">ğŸ“Š</div>
        <div>
          <h1>ë°©ì†¡ ë§¤ì¶œ ëŒ€ì‹œë³´ë“œ</h1>
          <p>ì—‘ì…€ ìŠ¬ë¼ì´ì„œì²˜ëŸ¼ ì„ íƒí•˜ë©´ KPI/ì°¨íŠ¸ê°€ ì¦‰ì‹œ ë³€ê²½ë©ë‹ˆë‹¤.</p>
        </div>
      </div>
      <div style="display:flex;gap:10px;align-items:center">
        <span class="pill" id="statusPill">ìƒíƒœ: -</span>
        <button class="btn" id="btnReset">ì „ì²´ í•´ì œ</button>
        <button class="btn primary" id="btnRefresh">ìƒˆë¡œê³ ì¹¨</button>
        <button class="btn" id="btnKey">í‚¤ ë³€ê²½</button>
      </div>
    </div>

    <div class="grid">
      <!-- filters -->
      <div class="card filters">
        <div class="hd"><h3 style="margin:0;font-size:16px">í•„í„°(ìŠ¬ë¼ì´ì„œ)</h3></div>
        <div class="bd" id="filters"></div>
        <div class="bd" style="padding-top:0;color:var(--muted);font-size:12px">
          â€» í‚¤ë¥¼ ëª¨ë¥´ë©´ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
        </div>
      </div>

      <!-- main -->
      <div>
        <div class="card" style="margin-bottom:14px">
          <div class="bd">
            <div class="status">
              <div class="left">
                <span class="pill" id="statusText">ìƒíƒœ: -</span>
              </div>
              <div style="color:var(--muted);font-size:13px" id="updatedText">ì—…ë°ì´íŠ¸: -</div>
            </div>

            <div class="kpis" id="kpis"></div>
          </div>
        </div>

        <div class="charts">
          <div class="card">
            <div class="hd"><h3 style="margin:0">ë°©ì†¡ì±„ë„ë³„ (ëª©í‘œ/ì‹¤ì /ë‹¬ì„±ìœ¨)</h3></div>
            <div class="bd"><div class="chartBox" id="boxChannel"><canvas id="chChannel"></canvas></div></div>
          </div>

          <div class="card">
            <div class="hd"><h3 style="margin:0">ì›”ë³„ (ëª©í‘œ/ì‹¤ì /ë‹¬ì„±ìœ¨)</h3></div>
            <div class="bd"><div class="chartBox" id="boxMonth"><canvas id="chMonth"></canvas></div></div>
          </div>

          <div class="card">
            <div class="hd"><h3 style="margin:0">ìš”ì¼ë³„ (ëª©í‘œ/ì‹¤ì /ë‹¬ì„±ìœ¨)</h3></div>
            <div class="bd"><div class="chartBox short" id="boxDow"><canvas id="chDow"></canvas></div></div>
          </div>

          <div class="card">
            <div class="hd"><h3 style="margin:0">ì¼ìë³„ (ëª©í‘œ/ì‹¤ì /ë‹¬ì„±ìœ¨) - TOP 30</h3></div>
            <div class="bd"><div class="chartBox tall" id="boxDay"><canvas id="chDay"></canvas></div></div>
          </div>

          <div class="card span2">
            <div class="hd"><h3 style="margin:0">ì•„ì´í…œë³„ (ëª©í‘œ/ì‹¤ì /ë‹¬ì„±ìœ¨)</h3></div>
            <div class="bd"><div class="chartBox tall" id="boxItem"><canvas id="chItem"></canvas></div></div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/** =========================
 *  âœ… ì—¬ê¸°ë§Œ ë°”ê¿”!
 *  ========================= */
const API_URL = "https://script.google.com/macros/s/AKfycbzpLQ2wcNZIuisAjsaDTxA_Lj1E5X6CWEeZffW0_PPdjHTAo7peoHig1UmzyvXbkLHUuw/exec"; // ì˜ˆ: https://script.google.com/macros/s/....../exec
const DEFAULT_KEY = "WHHS-PSM-221035"; // ì›í•˜ë©´ ê¸°ë³¸ í‚¤(ë¹„ì›Œë„ ë¨)

/** =========================
 *  State
 *  ========================= */
const DOW_ORDER = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
const store = {
  key: localStorage.getItem('dash_key') || DEFAULT_KEY,
  filters: { years:[], months:[], days:[], dows:[], items:[], channels:[] },
  options: null,
  charts: { channel:null, month:null, dow:null, day:null, item:null },
  renderQueued: false,
};

const elStatusPill = document.getElementById('statusPill');
const elStatusText = document.getElementById('statusText');
const elUpdated = document.getElementById('updatedText');
const elFilters = document.getElementById('filters');
const elKpis = document.getElementById('kpis');

document.getElementById('btnKey').addEventListener('click', () => {
  const k = prompt("ì ‘ì† í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”", store.key || "");
  if (k == null) return;
  store.key = (k || "").trim();
  localStorage.setItem('dash_key', store.key);
  loadAll(true);
});

document.getElementById('btnRefresh').addEventListener('click', ()=> loadAll(true));
document.getElementById('btnReset').addEventListener('click', ()=>{
  store.filters = { years:[], months:[], days:[], dows:[], items:[], channels:[] };
  renderFilters();
  loadAll(true);
});

/** =========================
 *  Helpers
 *  ========================= */
function setStatus(ok, msg){
  const t = ok ? `ìƒíƒœ: ì •ìƒ Â· ${msg}` : `ìƒíƒœ: ì˜¤ë¥˜ Â· ${msg}`;
  elStatusPill.textContent = t;
  elStatusText.textContent = t;
  elStatusPill.style.color = ok ? '#166534' : '#b91c1c';
  elStatusText.style.color = ok ? '#166534' : '#b91c1c';
}
function fmt(n, d=0){
  const x = Number(n||0);
  return x.toLocaleString(undefined,{maximumFractionDigits:d});
}
function fmtPct(p, d=1){
  // pê°€ 0~1ë¡œ ì˜¤ë“  0~100ìœ¼ë¡œ ì˜¤ë“  "ì‚¬ëŒì´ ë³´ëŠ” %"ë¡œ ì •ê·œí™”
  let v = Number(p||0);
  if (v <= 1.5) v = v * 100;
  return `${v.toFixed(d)}%`;
}
function qs(obj){
  const u = new URLSearchParams();
  Object.entries(obj).forEach(([k,v])=>{
    if (Array.isArray(v) && v.length){
      u.set(k, v.join(','));
    } else if (v !== undefined && v !== null && v !== '' && !(Array.isArray(v) && !v.length)) {
      u.set(k, v);
    }
  });
  return u.toString();
}
function debounceRender(fn){
  if (store.renderQueued) return;
  store.renderQueued = true;
  requestAnimationFrame(()=>{
    store.renderQueued = false;
    fn();
  });
}

/** =========================
 *  API
 *  ========================= */
function jsonp(url){
  return new Promise((resolve,reject)=>{
    const cb = "CB_" + Math.random().toString(36).slice(2);
    const s = document.createElement('script');
    const cleanup = () => {
      delete window[cb];
      s.remove();
    };
    window[cb] = (data) => { cleanup(); resolve(data); };
    s.onerror = () => { cleanup(); reject(new Error("JSONP load failed")); };
    s.src = url + (url.includes('?') ? '&' : '?') + 'callback=' + cb;
    document.body.appendChild(s);
    setTimeout(()=>{ cleanup(); reject(new Error("JSONP timeout")); }, 20000);
  });
}

async function apiFetch(action){
  if (!API_URL || API_URL.includes("PASTE_YOUR")) throw new Error("API_URLì„ ì„¤ì •í•´ì•¼ í•©ë‹ˆë‹¤.");
  if (!store.key) throw new Error("í‚¤ê°€ ì—†ìŠµë‹ˆë‹¤. ìš°ì¸¡ ìƒë‹¨ 'í‚¤ ë³€ê²½'ì—ì„œ ì…ë ¥í•˜ì„¸ìš”.");

  const payload = {
    action,
    key: store.key,
    years: store.filters.years,
    months: store.filters.months,
    days: store.filters.days,
    dows: store.filters.dows,
    items: store.filters.items,
    channels: store.filters.channels,
  };
  const url = `${API_URL}?${qs(payload)}`;
  const res = await jsonp(url);
  if (!res || res.ok === false) throw new Error(res?.message || "API error");
  return res;
}

/** =========================
 *  UI: Filters
 *  ========================= */
function toggleInList(list, v){
  const i = list.indexOf(v);
  if (i>=0) list.splice(i,1);
  else list.push(v);
}
function sortMonth(arr){ return [...arr].map(Number).sort((a,b)=>a-b).map(String); }
function sortDay(arr){ return [...arr].map(Number).sort((a,b)=>a-b).map(String); }
function sortDow(arr){
  const set = new Set(arr);
  return DOW_ORDER.filter(x=>set.has(x));
}
function renderFilters(){
  if (!store.options){
    elFilters.innerHTML = `<div style="color:var(--muted);font-size:13px">ì˜µì…˜ ë¡œë”© ì¤‘...</div>`;
    return;
  }
  const opts = store.options;

  const sections = [
    { key:'years', label:'ì—°ë„', values: opts.years || [], sort: (a)=>a },
    { key:'months', label:'ì›”', values: sortMonth(opts.months||[]), sort: sortMonth },
    { key:'days', label:'ì¼', values: sortDay(opts.days||[]), sort: sortDay },
    { key:'dows', label:'ìš”ì¼', values: sortDow(opts.dows||[]), sort: sortDow },
    { key:'items', label:'ì•„ì´í…œ', values: (opts.items||[]).filter(v=>v && v!=='(ë¹„ì–´ìˆìŒ)'), sort: (a)=>a },
    { key:'channels', label:'ë°©ì†¡ì±„ë„', values: (opts.channels||[]).filter(v=>v && v!=='(ë¹„ì–´ìˆìŒ)').sort((a,b)=>String(a).localeCompare(String(b))), sort: (a)=>a },
  ];

  elFilters.innerHTML = sections.map(sec=>{
    const sel = store.filters[sec.key] || [];
    return `
      <div class="sec">
        <div class="row">
          <h3>${sec.label}</h3>
          <div class="tools">
            <button class="btn" data-act="all" data-key="${sec.key}">ì „ì²´</button>
            <button class="btn" data-act="clear" data-key="${sec.key}">í•´ì œ</button>
          </div>
        </div>
        <div class="chips">
          ${sec.values.map(v=>{
            const on = sel.includes(String(v));
            return `<div class="chip ${on?'on':''}" data-key="${sec.key}" data-val="${String(v)}">${String(v)}</div>`;
          }).join('')}
        </div>
      </div>
    `;
  }).join('');

  elFilters.querySelectorAll('.chip').forEach(ch=>{
    ch.addEventListener('click', ()=>{
      const k = ch.dataset.key;
      const v = ch.dataset.val;
      toggleInList(store.filters[k], v);
      renderFilters();
      loadAll(false);
    });
  });
  elFilters.querySelectorAll('button[data-act]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const k = btn.dataset.key;
      const act = btn.dataset.act;
      const sec = sections.find(s=>s.key===k);
      if (!sec) return;
      if (act==='all'){
        store.filters[k] = sec.values.map(String);
      } else {
        store.filters[k] = [];
      }
      renderFilters();
      loadAll(false);
    });
  });
}

/** =========================
 *  Charts
 *  ========================= */
function destroyChart(ch){
  if (ch && typeof ch.destroy === 'function') ch.destroy();
}

function makeComboChart(canvasId, title, labels, goal, actual, ratePct, count){
  const ctx = document.getElementById(canvasId);
  // âœ… ë¬´í•œ ê¸¸ì–´ì§ ë°©ì§€ 1: ê¸°ì¡´ ì°¨íŠ¸ ì œê±°
  destroyChart(store.charts[canvasIdMap(canvasId)]);
  // âœ… ë¬´í•œ ê¸¸ì–´ì§ ë°©ì§€ 2: ìº”ë²„ìŠ¤ ì‚¬ì´ì¦ˆ ë¦¬ì…‹(ê°„í˜¹ ë¸Œë¼ìš°ì €ì—ì„œ ëˆ„ì ë¨)
  ctx.width = ctx.width;

  const c = new Chart(ctx, {
    data: {
      labels,
      datasets: [
        { type:'bar', label:'ëª©í‘œ(í•©ê³„)', data: goal, yAxisID:'y', borderWidth:0, barPercentage:.8, categoryPercentage:.7 },
        { type:'bar', label:'ì‹¤ì (í•©ê³„)', data: actual, yAxisID:'y', borderWidth:0, barPercentage:.8, categoryPercentage:.7 },
        { type:'scatter', label:'ë‹¬ì„±ìœ¨(%)', data: ratePct.map((v,i)=>({x:labels[i], y:v})), yAxisID:'y1', pointRadius:4, pointHoverRadius:8 },
      ]
    },
    options: {
      responsive:true,
      maintainAspectRatio:false, // âœ… í•µì‹¬
      animation:false,
      plugins:{
        legend:{ position:'top' },
        tooltip:{
          intersect:false,
          mode:'index',
          callbacks:{
            afterBody:(items)=>{
              const i = items?.[0]?.dataIndex ?? -1;
              if (i<0) return '';
              const lines = [];
              lines.push(`ë°©ì†¡íšŸìˆ˜: ${fmt(count?.[i] ?? 0)}`);
              lines.push(`ë‹¬ì„±ìœ¨: ${fmtPct(ratePct?.[i] ?? 0, 1)}`);
              return lines;
            }
          }
        },
        title:{ display:false, text:title }
      },
      scales:{
        y:{ beginAtZero:true },
        y1:{
          beginAtZero:true,
          position:'right',
          grid:{ drawOnChartArea:false },
          ticks:{ callback:(v)=> v + '%' }
        }
      }
    }
  });

  store.charts[canvasIdMap(canvasId)] = c;
}

function canvasIdMap(id){
  return {
    chChannel:'channel',
    chMonth:'month',
    chDow:'dow',
    chDay:'day',
    chItem:'item'
  }[id];
}

/** =========================
 *  Render
 *  ========================= */
function renderKpis(k){
  const items = [
    ['ë°©ì†¡íšŸìˆ˜', fmt(k.broadcastCount)],
    ['íŠ¹ì•½íšŸìˆ˜', fmt(k.specialCount)],
    ['íŠ¹ì•½ë¹„ìš©', fmt(k.specialCost, 2)],
    ['í‰ê· ë‹¬ì„±ìœ¨', fmtPct(k.achievementRate, 1)],
    ['ë°©ì†¡ì‹œê°„(ë¶„)', fmt(k.totalMinutes)],
    ['ì‹œê°„ë‹¹ë§¤ì¶œ', fmt(k.salesPerHour, 2)],
  ];
  elKpis.innerHTML = items.map(([k,v])=>`
    <div class="kpi"><div class="k">${k}</div><div class="v">${v}</div></div>
  `).join('');
}

function safeArr(a){ return Array.isArray(a) ? a : []; }

/** =========================
 *  Main load
 *  ========================= */
async function loadAll(force){
  try{
    setStatus(true, 'ë¡œë”© ì¤‘...');
    const [opt, dash] = await Promise.all([
      (async()=>{ 
        // ì˜µì…˜ì´ ì—†ìœ¼ë©´ ì˜µì…˜ë¶€í„°
        if (!store.options || force){
          const o = await apiFetch('options');
          store.options = o.options || o; 
          renderFilters();
        }
      })(),
      apiFetch('dashboard'),
    ]);

    const data = dash;

    elUpdated.textContent = `ì—…ë°ì´íŠ¸: ${data.updated || '-'}`;
    setStatus(true, 'í•„í„° ì ìš© ì™„ë£Œ');

    renderKpis(data.kpis);

    // âœ… ì°¨íŠ¸ê°€ ê¸¸ì–´ì§€ëŠ” ë¬¸ì œëŠ” "ë§¤ë²ˆ destroy + ê³ ì • ë†’ì´ + maintainAspectRatio:false"ë¡œ í•´ê²°
    debounceRender(()=>{
      // ë°©ì†¡ì±„ë„: a~z ì •ë ¬
      const ch = data.charts.channel;
      const idx = safeArr(ch.labels).map((v,i)=>[String(v), i])
        .filter(([v])=>v && v!=='(ë¹„ì–´ìˆìŒ)')
        .sort((a,b)=>a[0].localeCompare(b[0], 'en'));
      const pick = (arr)=> idx.map(([_,i])=> arr[i]);

      makeComboChart(
        'chChannel',
        'ë°©ì†¡ì±„ë„ë³„',
        idx.map(x=>x[0]),
        pick(ch.goal),
        pick(ch.actual),
        pick(ch.ratePct),
        pick(ch.count)
      );

      makeComboChart('chMonth','ì›”ë³„',
        data.charts.month.labels,
        data.charts.month.goal,
        data.charts.month.actual,
        data.charts.month.ratePct,
        data.charts.month.count
      );

      makeComboChart('chDow','ìš”ì¼ë³„',
        data.charts.dow.labels,
        data.charts.dow.goal,
        data.charts.dow.actual,
        data.charts.dow.ratePct,
        data.charts.dow.count
      );

      makeComboChart('chDay','ì¼ìë³„',
        data.charts.day.labels,
        data.charts.day.goal,
        data.charts.day.actual,
        data.charts.day.ratePct,
        data.charts.day.count
      );

      makeComboChart('chItem','ì•„ì´í…œë³„',
        data.charts.item.labels,
        data.charts.item.goal,
        data.charts.item.actual,
        data.charts.item.ratePct,
        data.charts.item.count
      );
    });

  } catch(err){
    console.error(err);
    setStatus(false, err.message || String(err));
  }
}

(async function init(){
  if (!store.key){
    const k = prompt("ì ‘ì† í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”");
    store.key = (k || "").trim();
    localStorage.setItem('dash_key', store.key);
  }
  await loadAll(true);
})();
</script>
</body>
</html>
