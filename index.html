<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ë°©ì†¡ ë§¤ì¶œ ëŒ€ì‹œë³´ë“œ</title>
  <meta name="robots" content="noindex,nofollow" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg:#f5f7fb; --card:#fff; --muted:#6b7280; --text:#111827;
      --border:#e5e7eb; --soft:#eaf2ff; --accent:#2563eb;
      --radius:14px;
    }
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Apple SD Gothic Neo","Noto Sans KR",sans-serif;
      background:var(--bg); margin:0; padding:14px; color:var(--text);
    }
    header{ display:flex; align-items:center; gap:10px; margin-bottom:6px; }
    header h1{ margin:0; font-size:24px; letter-spacing:-.4px; }
    .sub{ margin:0 0 10px 0; color:var(--muted); font-size:12px; }

    .status{
      display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;
      border:1px solid var(--border); border-radius:var(--radius); background:var(--card);
      padding:8px 10px;
    }
    .status b{ font-weight:900; }
    .btn{
      border:1px solid var(--border); background:#fff; border-radius:10px;
      padding:7px 9px; cursor:pointer; font-size:12px;
    }
    .btn:hover{ background:#f9fafb; }
    .btn.primary{ border-color:#c7d2fe; background:#eef2ff; }

    .grid{ display:grid; grid-template-columns: 300px 1fr; gap:12px; align-items:start; margin-top:12px; }
    @media(max-width:1050px){ .grid{ grid-template-columns:1fr; } }

    .panel{ background:var(--card); border:1px solid var(--border); border-radius:var(--radius); padding:10px; }
    .panel h2{ margin:0 0 8px 0; font-size:14px; }

    .kpis{ display:grid; grid-template-columns: repeat(6, minmax(140px, 1fr)); gap:10px; margin-bottom:10px; }
    @media(max-width:1180px){ .kpis{ grid-template-columns: repeat(3, minmax(140px, 1fr)); } }
    @media(max-width:620px){ .kpis{ grid-template-columns:1fr; } }

    .kpi{ background:var(--soft); border-radius:var(--radius); padding:10px 12px; }
    .kpi .label{ color:var(--muted); font-size:11px; margin-bottom:4px; }
    .kpi .value{ font-size:18px; font-weight:900; letter-spacing:-.4px; }

    /* ìŠ¬ë¼ì´ì„œ(ì‘ê²Œ) */
    .slicer{ margin-top:8px; }
    .slicer-head{ display:flex; justify-content:space-between; align-items:center; gap:8px; }
    .slicer-head .title{ font-weight:900; font-size:12px; }
    .chips{ display:flex; flex-wrap:wrap; gap:6px; margin-top:6px; }
    .chip{
      border:1px solid var(--border); background:#fff; border-radius:999px;
      padding:5px 8px; font-size:12px; cursor:pointer; user-select:none;
    }
    .chip.on{ border-color:#bfdbfe; background:#eff6ff; color:#1d4ed8; font-weight:800; }
    .chip:active{ transform: translateY(1px); }

    /* ì°¨íŠ¸ ë ˆì´ì•„ì›ƒ(í•œ ëˆˆì—) */
    .charts{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media(max-width:1050px){ .charts{ grid-template-columns:1fr; } }

    .section{
      background:var(--card); border:1px solid var(--border); border-radius:var(--radius);
      padding:10px;
    }
    .section h3{ margin:0 0 8px 0; font-size:14px; }

    /* ê·¸ë˜í”„ ë†’ì´ ì¤„ì´ê¸° */
    .chartBox{ height:240px; }
    .chartBox.tall{ height:270px; }
    canvas{ width:100% !important; height:100% !important; }
  </style>
</head>

<body>
  <header>
    <div style="font-size:26px">ğŸ“Š</div>
    <h1>ë°©ì†¡ ë§¤ì¶œ ëŒ€ì‹œë³´ë“œ</h1>
  </header>
  <p class="sub">ì—‘ì…€ ìŠ¬ë¼ì´ì„œì²˜ëŸ¼ ì„ íƒí•˜ë©´ KPI/ì°¨íŠ¸ê°€ ì¦‰ì‹œ ë³€ê²½ë©ë‹ˆë‹¤.</p>

  <div class="status">
    <div>ìƒíƒœ: <b id="statusText">ë¡œë”©â€¦</b> <span id="statusHint" style="color:var(--muted)"></span></div>
    <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
      <span id="lastUpdated" style="color:var(--muted); font-size:12px;"></span>
      <button class="btn" id="resetBtn">ì „ì²´ í•´ì œ</button>
      <button class="btn primary" id="refreshBtn">ìƒˆë¡œê³ ì¹¨</button>
    </div>
  </div>

  <div class="grid">
    <!-- LEFT: slicers -->
    <div class="panel">
      <h2>í•„í„°(ìŠ¬ë¼ì´ì„œ)</h2>

      <!-- ìš”ì²­í•œ ìˆœì„œ: ì—°ë„, ì›”, ì¼, ìš”ì¼, ì•„ì´í…œ, ë°©ì†¡ì±„ë„ -->
      <div class="slicer" id="slicerYears"></div>
      <div class="slicer" id="slicerMonths"></div>
      <div class="slicer" id="slicerDays"></div>
      <div class="slicer" id="slicerDows"></div>
      <div class="slicer" id="slicerItems"></div>
      <div class="slicer" id="slicerChannels"></div>
    </div>

    <!-- RIGHT -->
    <div>
      <div class="kpis" id="kpis"></div>

      <div class="charts">
        <div class="section">
          <h3>ë°©ì†¡ì±„ë„ë³„ (ëª©í‘œ/ì‹¤ì /ë‹¬ì„±ìœ¨)</h3>
          <div class="chartBox"><canvas id="channelChart"></canvas></div>
        </div>

        <div class="section">
          <h3>ì›”ë³„ (ëª©í‘œ/ì‹¤ì /ë‹¬ì„±ìœ¨)</h3>
          <div class="chartBox"><canvas id="monthChart"></canvas></div>
        </div>

        <div class="section">
          <h3>ìš”ì¼ë³„ (ëª©í‘œ/ì‹¤ì /ë‹¬ì„±ìœ¨)</h3>
          <div class="chartBox"><canvas id="dowChart"></canvas></div>
        </div>

        <div class="section">
          <h3>ì¼ìë³„ (ëª©í‘œ/ì‹¤ì /ë‹¬ì„±ìœ¨)</h3>
          <div class="chartBox tall"><canvas id="dayChart"></canvas></div>
        </div>

        <div class="section" style="grid-column: 1 / -1;">
          <h3>ì•„ì´í…œë³„ (ëª©í‘œ/ì‹¤ì /ë‹¬ì„±ìœ¨)</h3>
          <div class="chartBox tall"><canvas id="itemChart"></canvas></div>
        </div>
      </div>
    </div>
  </div>

<script>
/*** âœ… ë³¸ì¸ Apps Script exec URL ì…ë ¥ ***/
const API_URL = "https://script.google.com/macros/s/AKfycbzpLQ2wcNZIuisAjsaDTxA_Lj1E5X6CWEeZffW0_PPdjHTAo7peoHig1UmzyvXbkLHUuw/exec"; // â† ì—¬ê¸°ë§Œ ë°”ê¾¸ì„¸ìš”

/*** JSONP ìœ í‹¸ ***/
function jsonp(url){
  return new Promise((resolve, reject) => {
    const cb = "cb_" + Math.random().toString(36).slice(2);
    const script = document.createElement("script");
    window[cb] = (data) => { resolve(data); try{ delete window[cb]; }catch(e){ window[cb]=undefined; } script.remove(); };
    const sep = url.includes("?") ? "&" : "?";
    script.src = url + sep + "callback=" + cb;
    script.onerror = () => { reject(new Error("JSONP load failed")); try{ delete window[cb]; }catch(e){ window[cb]=undefined; } script.remove(); };
    document.body.appendChild(script);
  });
}

function setStatus(ok, text, hint=""){
  const el = document.getElementById("statusText");
  const hintEl = document.getElementById("statusHint");
  el.textContent = text;
  hintEl.textContent = hint ? ` Â· ${hint}` : "";
  el.style.color = ok ? "#059669" : "#dc2626";
}
function updateTimestamp(){
  document.getElementById("lastUpdated").textContent =
    "ì—…ë°ì´íŠ¸: " + new Date().toLocaleString("ko-KR");
}
function fmtNumber(x){
  const n = Number(x);
  if(!isFinite(n)) return "-";
  return Math.round(n).toLocaleString("ko-KR");
}
function fmtMoney(x){ return fmtNumber(x); }
function fmtPercent01(x){
  const n = Number(x);
  if(!isFinite(n)) return "-";
  return Math.round(n*100) + "%";
}

/*** ì„ íƒ ìƒíƒœ ***/
const state = {
  years: new Set(),
  months: new Set(),
  days: new Set(),
  dows: new Set(),
  items: new Set(),
  channels: new Set(),
};

function readStateFromUrl(){
  const sp = new URLSearchParams(location.search);
  ["years","months","days","dows","items","channels"].forEach(k=>{
    state[k].clear();
    const v = sp.get(k);
    if(v) v.split(",").map(s=>s.trim()).filter(Boolean).forEach(x=>state[k].add(x));
  });
}
function writeStateToUrl(){
  const sp = new URLSearchParams();
  ["years","months","days","dows","items","channels"].forEach(k=>{
    if(state[k].size) sp.set(k, [...state[k]].join(","));
  });
  history.replaceState(null, "", location.pathname + (sp.toString()?("?"+sp.toString()):""));
}
function buildQueryFromState(){
  const sp = new URLSearchParams();
  ["years","months","days","dows","items","channels"].forEach(k=>{
    if(state[k].size) sp.set(k, [...state[k]].join(","));
  });
  return sp.toString();
}

/*** ìŠ¬ë¼ì´ì„œ ë Œë” ***/
function renderSlicer(containerId, title, key, options){
  const container = document.getElementById(containerId);
  const selected = state[key];

  const chipsHtml = (options || []).map(v=>{
    const vv = String(v);
    const on = selected.has(vv);
    return `<div class="chip ${on?'on':''}" data-key="${key}" data-val="${vv}">${vv}</div>`;
  }).join("");

  container.innerHTML = `
    <div class="slicer-head">
      <div class="title">${title}</div>
      <div style="display:flex; gap:6px;">
        <button class="btn" data-action="all" data-key="${key}">ì „ì²´</button>
        <button class="btn" data-action="none" data-key="${key}">í•´ì œ</button>
      </div>
    </div>
    <div class="chips">${chipsHtml || '<span style="color:var(--muted);font-size:12px;">(ì˜µì…˜ ì—†ìŒ)</span>'}</div>
  `;
}

/*** KPI 6ê°œ (ìš”ì²­í•œ ìˆœì„œ) ***/
function renderKpis(d){
  document.getElementById("kpis").innerHTML = `
    <div class="kpi"><div class="label">ë°©ì†¡íšŸìˆ˜</div><div class="value">${fmtNumber(d["ë°©ì†¡íšŸìˆ˜"])}</div></div>
    <div class="kpi"><div class="label">íŠ¹ì•½íšŸìˆ˜</div><div class="value">${fmtNumber(d["íŠ¹ì•½íšŸìˆ˜"])}</div></div>
    <div class="kpi"><div class="label">íŠ¹ì•½ë¹„ìš©</div><div class="value">${fmtMoney(d["íŠ¹ì•½ë¹„ìš©"])}</div></div>
    <div class="kpi"><div class="label">í‰ê· ë‹¬ì„±ìœ¨</div><div class="value">${fmtPercent01(d["í‰ê· ë‹¬ì„±ìœ¨"])}</div></div>
    <div class="kpi"><div class="label">ë°©ì†¡ì‹œê°„(ë¶„)</div><div class="value">${fmtNumber(d["ë°©ì†¡ì‹œê°„_ë¶„"])}</div></div>
    <div class="kpi"><div class="label">ì‹œê°„ë‹¹ë§¤ì¶œ</div><div class="value">${fmtMoney(d["ì‹œê°„ë‹¹ë§¤ì¶œ"])}</div></div>
  `;
}

/*** Chart: ëª©í‘œ/ì‹¤ì  bar ê²¹ì¹¨ + ë‹¬ì„±ìœ¨ line + tooltipì— ë°©ì†¡íšŸìˆ˜ í‘œì‹œ ***/
let charts = {};
function drawPivotChart(canvasId, labels, goals, actuals, achs, counts, horizontal=false){
  const ctx = document.getElementById(canvasId);
  if(charts[canvasId]) charts[canvasId].destroy();

  charts[canvasId] = new Chart(ctx, {
    data: {
      labels: labels || [],
      datasets: [
        {
          type: 'bar',
          label: 'ëª©í‘œ',
          data: (goals || []).map(Number),
          // ê²¹ì³ë³´ì´ê²Œ(í° ë°”)
          barPercentage: 0.9,
          categoryPercentage: 0.8,
        },
        {
          type: 'bar',
          label: 'ì‹¤ì ',
          data: (actuals || []).map(Number),
          // ê²¹ì³ë³´ì´ê²Œ(ì‘ì€ ë°”)
          barPercentage: 0.55,
          categoryPercentage: 0.8,
        },
        {
          type: 'line',
          label: 'ë‹¬ì„±ìœ¨(%)',
          data: (achs || []).map(v=>Number(v)*100),
          yAxisID: 'y1',
          tension: 0.25,
          pointRadius: 2
        }
      ]
    },
    options: {
      indexAxis: horizontal ? 'y' : 'x',
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          title: { display: false }
        },
        y1: {
          beginAtZero: true,
          position: 'right',
          grid: { drawOnChartArea: false },
          ticks: { callback: (v)=> v + '%' }
        }
      },
      plugins: {
        tooltip: {
          callbacks: {
            afterBody: (items) => {
              const i = items?.[0]?.dataIndex;
              if (i == null) return '';
              const cnt = counts?.[i];
              return cnt != null ? `ë°©ì†¡íšŸìˆ˜: ${cnt}` : '';
            }
          }
        },
        legend: { display: true }
      }
    }
  });
}

/*** ë°ì´í„° ë¡œë” ***/
async function loadOptions(){
  const d = await jsonp(API_URL + "?action=options");
  if(d && d.error) throw new Error(d.error);

  // months/days/dowsëŠ” ë°±ì—”ë“œì—ì„œ ì •ë ¬ë¨. ì•ˆì „í•˜ê²Œ í”„ë¡ íŠ¸ì—ì„œë„ ì •ë ¬ ë³´ì •.
  const months = (d.months || []).slice().sort((a,b)=>Number(a)-Number(b));
  const days = (d.days || []).slice().sort((a,b)=>Number(a)-Number(b));
  const dowOrder = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
  const dows = (d.dows || []).filter(x=>dowOrder.includes(x)).sort((a,b)=>dowOrder.indexOf(a)-dowOrder.indexOf(b));

  renderSlicer("slicerYears", "ì—°ë„", "years", d.years || []);
  renderSlicer("slicerMonths", "ì›”", "months", months);
  renderSlicer("slicerDays", "ì¼", "days", days);
  renderSlicer("slicerDows", "ìš”ì¼", "dows", dows);
  renderSlicer("slicerItems", "ì•„ì´í…œ", "items", d.items || []);
  renderSlicer("slicerChannels", "ë°©ì†¡ì±„ë„", "channels", d.channels || []);
}

async function loadSummary(){
  const q = buildQueryFromState();
  const d = await jsonp(API_URL + "?action=summary" + (q ? "&" + q : ""));
  if(d && d.error) throw new Error(d.error);
  renderKpis(d);
}

async function loadCharts(){
  const q = buildQueryFromState();
  const suffix = q ? "&" + q : "";

  const ch = await jsonp(API_URL + "?action=statsbar&by=ë°©ì†¡ì±„ë„&top=30" + suffix);
  if(ch && ch.error) throw new Error(ch.error);
  drawPivotChart("channelChart", ch.labels, ch.goals, ch.actuals, ch.achs, ch.counts, false);

  const mo = await jsonp(API_URL + "?action=statsbar&by=ì›”&top=12" + suffix);
  if(mo && mo.error) throw new Error(mo.error);
  drawPivotChart("monthChart", mo.labels, mo.goals, mo.actuals, mo.achs, mo.counts, false);

  const dw = await jsonp(API_URL + "?action=statsbar&by=ìš”ì¼&top=7" + suffix);
  if(dw && dw.error) throw new Error(dw.error);
  drawPivotChart("dowChart", dw.labels, dw.goals, dw.actuals, dw.achs, dw.counts, false);

  // ì¼ìë³„ (ê°€ë¡œë§‰ëŒ€ ê°€ëŠ¥)
  const dy = await jsonp(API_URL + "?action=statsbar&by=ì¼ì&top=31" + suffix);
  if(dy && dy.error) throw new Error(dy.error);
  drawPivotChart("dayChart", dy.labels, dy.goals, dy.actuals, dy.achs, dy.counts, true);

  // ì•„ì´í…œë³„ (ê°€ë¡œë§‰ëŒ€)
  const it = await jsonp(API_URL + "?action=statsbar&by=ì•„ì´í…œ&top=30" + suffix);
  if(it && it.error) throw new Error(it.error);
  drawPivotChart("itemChart", it.labels, it.goals, it.actuals, it.achs, it.counts, true);
}

async function refreshAll(){
  try{
    setStatus(true, "ë¡œë”© ì¤‘â€¦");
    writeStateToUrl();
    await loadSummary();
    await loadCharts();
    updateTimestamp();
    setStatus(true, "ì •ìƒ", "í•„í„° ì ìš© ì™„ë£Œ");
  }catch(err){
    console.error(err);
    setStatus(false, "ì˜¤ë¥˜", err.message || String(err));
  }
}

/*** ì´ë²¤íŠ¸: ì¹©/ì „ì²´/í•´ì œ ***/
document.addEventListener("click", async (ev) => {
  const chip = ev.target.closest(".chip");
  if(chip){
    const key = chip.dataset.key;
    const val = chip.dataset.val;
    if(state[key].has(val)) state[key].delete(val);
    else state[key].add(val);
    chip.classList.toggle("on");
    await refreshAll();
    return;
  }

  const actionBtn = ev.target.closest("button[data-action]");
  if(actionBtn){
    const key = actionBtn.dataset.key;
    const action = actionBtn.dataset.action;
    const parent = actionBtn.closest(".slicer");
    const chipEls = parent ? parent.querySelectorAll(`.chip[data-key="${key}"]`) : [];

    if(action === "none"){
      state[key].clear();
      chipEls.forEach(c=>c.classList.remove("on"));
      await refreshAll();
    }
    if(action === "all"){
      chipEls.forEach(c=>state[key].add(c.dataset.val));
      chipEls.forEach(c=>c.classList.add("on"));
      await refreshAll();
    }
  }
});

document.getElementById("resetBtn").addEventListener("click", async ()=>{
  ["years","months","days","dows","items","channels"].forEach(k=>state[k].clear());
  await loadOptions();
  await refreshAll();
});

document.getElementById("refreshBtn").addEventListener("click", async ()=>{
  await refreshAll();
});

/*** ì´ˆê¸° ì‹¤í–‰ ***/
(async function init(){
  readStateFromUrl();
  await loadOptions();
  await refreshAll();
})();
</script>
</body>
</html>
