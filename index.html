<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Sales Dashboard</title>

  <!-- ê²€ìƒ‰ ë…¸ì¶œ ìµœì†Œí™” -->
  <meta name="robots" content="noindex,nofollow">

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: system-ui; background:#f5f7fb; margin:0; padding:20px; }
    h1 { margin-bottom:20px; }
    h2 { margin-top:40px; }
    .kpis { display:flex; gap:12px; flex-wrap:wrap; }
    .kpi { background:#eaf2ff; padding:14px 18px; border-radius:12px; min-width:140px; }
    canvas { max-width:100%; background:#fff; border-radius:12px; padding:12px; margin-top:10px; }
  </style>
</head>
<body>

<h1>ğŸ“Š ë°©ì†¡ ë§¤ì¶œ ëŒ€ì‹œë³´ë“œ</h1>

<div class="kpis" id="kpis"></div>

<h2>ë°©ì†¡ì±„ë„ë³„ ë‹¬ì„±ìœ¨</h2>
<canvas id="channelChart"></canvas>

<script>
/* ğŸ”½ ì—¬ê¸°ì— ë³¸ì¸ Apps Script ì›¹ì•± URL ë„£ê¸° */
const API_URL = "https://script.google.com/macros/s/AKfycbzpLQ2wcNZIuisAjsaDTxA_Lj1E5X6CWEeZffW0_PPdjHTAo7peoHig1UmzyvXbkLHUuw/exec";

function jsonp(url) {
  return new Promise((resolve, reject) => {
    const cb = "cb_" + Math.random().toString(36).slice(2);
    window[cb] = (data) => {
      resolve(data);
      delete window[cb];
      script.remove();
    };
    const script = document.createElement("script");
    script.src = url + (url.includes("?") ? "&" : "?") + "callback=" + cb;
    script.onerror = () => {
      reject(new Error("JSONP load failed"));
      delete window[cb];
      script.remove();
    };
    document.body.appendChild(script);
  });
}

async function loadSummary() {
  const d = await jsonp(API_URL + "?action=summary");
  document.getElementById("kpis").innerHTML = `
    <div class="kpi">ë°©ì†¡íšŸìˆ˜<br><b>${d["ë°©ì†¡íšŸìˆ˜"] ?? "-"}</b></div>
    <div class="kpi">íŠ¹ì•½íšŸìˆ˜<br><b>${d["íŠ¹ì•½íšŸìˆ˜"] ?? "-"}</b></div>
    <div class="kpi">í‰ê· ë‹¬ì„±ìœ¨<br><b>${d["í‰ê· ë‹¬ì„±ìœ¨"] != null ? Math.round(d["í‰ê· ë‹¬ì„±ìœ¨"]*100)+"%" : "-"}</b></div>
    <div class="kpi">ì‹œê°„ë‹¹ë§¤ì¶œ<br><b>${d["ì‹œê°„ë‹¹ë§¤ì¶œ"] != null ? Math.round(d["ì‹œê°„ë‹¹ë§¤ì¶œ"]) : "-"}</b></div>
  `;
}

let channelChart;
async function loadChannelChart() {
  const d = await jsonp(API_URL + "?action=bar&by=ë°©ì†¡ì±„ë„&metric=ë‹¬ì„±ìœ¨&agg=mean&top=30");

  const ctx = document.getElementById("channelChart");
  if (channelChart) channelChart.destroy();

  channelChart = new Chart(ctx, {
    type: "bar",
    data: {
      labels: d.labels || [],
      datasets: [{
        label: "ë‹¬ì„±ìœ¨(%)",
        data: (d.values || []).map(v => Number(v) * 100)
      }]
    },
    options: { scales: { y: { beginAtZero: true } } }
  });
}

(async function init(){
  await loadSummary();
  await loadChannelChart();
  setInterval(loadSummary, 10000);
  setInterval(loadChannelChart, 30000);
})();
</script>
