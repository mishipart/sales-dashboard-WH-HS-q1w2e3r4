<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ë°©ì†¡ ë§¤ì¶œ ëŒ€ì‹œë³´ë“œ</title>

  <!-- ê²€ìƒ‰ ë…¸ì¶œ ìµœì†Œí™” -->
  <meta name="robots" content="noindex,nofollow" />

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg:#f5f7fb;
      --card:#ffffff;
      --muted:#6b7280;
      --primary:#111827;
      --soft:#eaf2ff;
      --border:#e5e7eb;
      --radius:14px;
    }
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
      background: var(--bg);
      margin: 0;
      padding: 22px;
      color: var(--primary);
    }
    header{
      display:flex;
      align-items:center;
      gap:10px;
      margin-bottom:14px;
    }
    header h1{
      font-size: 30px;
      margin: 0;
      letter-spacing: -0.4px;
    }
    .sub{
      color: var(--muted);
      margin: 0 0 18px 0;
      font-size: 14px;
    }

    .status{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 10px 12px;
      margin: 0 0 14px 0;
      font-size: 13px;
      color: var(--muted);
      display:flex;
      gap:10px;
      align-items:center;
      justify-content: space-between;
    }
    .status b{ color: var(--primary); }
    .status .right{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap: wrap;
      justify-content:flex-end;
    }
    .btn{
      border: 1px solid var(--border);
      background: #fff;
      border-radius: 10px;
      padding: 8px 10px;
      cursor:pointer;
      font-size: 13px;
    }
    .btn:hover{ background:#f9fafb; }

    .kpis{
      display:grid;
      grid-template-columns: repeat(4, minmax(150px, 1fr));
      gap: 12px;
      margin: 14px 0 22px 0;
    }
    .kpi{
      background: var(--soft);
      border-radius: var(--radius);
      padding: 14px 16px;
      min-height: 74px;
    }
    .kpi .label{
      color: var(--muted);
      font-size: 12px;
      margin-bottom: 6px;
    }
    .kpi .value{
      font-size: 22px;
      font-weight: 800;
      letter-spacing: -0.4px;
    }

    .section{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 14px 14px 10px 14px;
      margin-top: 14px;
    }
    .section h2{
      font-size: 18px;
      margin: 4px 0 10px 0;
      letter-spacing: -0.2px;
    }
    canvas{
      width:100% !important;
      max-height: 360px;
    }

    @media (max-width: 980px){
      .kpis{ grid-template-columns: repeat(2, minmax(150px, 1fr)); }
      header h1{ font-size: 26px; }
    }
    @media (max-width: 520px){
      body{ padding: 14px; }
      .kpis{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <header>
    <div style="font-size:30px">ğŸ“Š</div>
    <h1>ë°©ì†¡ ë§¤ì¶œ ëŒ€ì‹œë³´ë“œ</h1>
  </header>
  <p class="sub">Google Sheets(data ì‹œíŠ¸) â†’ Apps Script API â†’ GitHub Pages (ì‹¤ì‹œê°„ ë°˜ì˜)</p>

  <div class="status" id="statusBox">
    <div>
      ìƒíƒœ: <b id="statusText">ë¡œë”© ì¤‘â€¦</b>
      <span id="statusHint"></span>
    </div>
    <div class="right">
      <span id="lastUpdated" style="color:var(--muted)"></span>
      <button class="btn" id="refreshBtn">ì§€ê¸ˆ ìƒˆë¡œê³ ì¹¨</button>
    </div>
  </div>

  <div class="kpis" id="kpis">
    <!-- KPIê°€ ì—¬ê¸°ì— ë Œë”ë§ -->
  </div>

  <div class="section">
    <h2>ë°©ì†¡ì±„ë„ë³„ ë‹¬ì„±ìœ¨</h2>
    <canvas id="channelChart"></canvas>
  </div>

  <script>
    /********************************************************
     * âœ… 1) ë³¸ì¸ Apps Script ì›¹ì•± exec URLì„ ë„£ì–´ì£¼ì„¸ìš”.
     * ì˜ˆ) https://script.google.com/macros/s/XXXX/exec
     ********************************************************/
    const API_URL = "https://script.google.com/macros/s/AKfycbzpLQ2wcNZIuisAjsaDTxA_Lj1E5X6CWEeZffW0_PPdjHTAo7peoHig1UmzyvXbkLHUuw/exec"; // â† ì—¬ê¸°ë§Œ ë°”ê¾¸ì„¸ìš”

    /********************************************************
     * JSONP í˜¸ì¶œ ìœ í‹¸ (GitHub Pages CORS íšŒí”¼)
     ********************************************************/
    function jsonp(url) {
      return new Promise((resolve, reject) => {
        const cb = "cb_" + Math.random().toString(36).slice(2);
        const script = document.createElement("script");

        window[cb] = (data) => {
          resolve(data);
          try { delete window[cb]; } catch(e) { window[cb] = undefined; }
          script.remove();
        };

        const sep = url.includes("?") ? "&" : "?";
        script.src = url + sep + "callback=" + cb;

        script.onerror = () => {
          reject(new Error("JSONP load failed"));
          try { delete window[cb]; } catch(e) { window[cb] = undefined; }
          script.remove();
        };

        document.body.appendChild(script);
      });
    }

    /********************************************************
     * í™”ë©´ í‘œì‹œìš© ìœ í‹¸
     ********************************************************/
    function setStatus(ok, text, hint="") {
      const statusText = document.getElementById("statusText");
      const statusHint = document.getElementById("statusHint");
      statusText.textContent = text;
      statusHint.textContent = hint ? ` Â· ${hint}` : "";
      statusText.style.color = ok ? "#059669" : "#dc2626";
    }

    function fmtNumber(x) {
      const n = Number(x);
      if (!isFinite(n)) return "-";
      return n.toLocaleString("ko-KR");
    }

    function fmtPercent01(x) {
      const n = Number(x);
      if (!isFinite(n)) return "-";
      return Math.round(n * 100) + "%";
    }

    function updateTimestamp() {
      const el = document.getElementById("lastUpdated");
      const now = new Date();
      el.textContent = `ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ${now.toLocaleString("ko-KR")}`;
    }

    /********************************************************
     * KPI ë Œë”
     ********************************************************/
    function renderKpis(d) {
      const el = document.getElementById("kpis");
      el.innerHTML = `
        <div class="kpi"><div class="label">ë°©ì†¡íšŸìˆ˜</div><div class="value">${fmtNumber(d["ë°©ì†¡íšŸìˆ˜"])}</div></div>
        <div class="kpi"><div class="label">íŠ¹ì•½íšŸìˆ˜</div><div class="value">${fmtNumber(d["íŠ¹ì•½íšŸìˆ˜"])}</div></div>
        <div class="kpi"><div class="label">í‰ê· ë‹¬ì„±ìœ¨</div><div class="value">${fmtPercent01(d["í‰ê· ë‹¬ì„±ìœ¨"])}</div></div>
        <div class="kpi"><div class="label">ì‹œê°„ë‹¹ë§¤ì¶œ</div><div class="value">${fmtNumber(Math.round(Number(d["ì‹œê°„ë‹¹ë§¤ì¶œ"])))}</div></div>
      `;
    }

    /********************************************************
     * Chart.js: ì±„ë„ ì°¨íŠ¸
     ********************************************************/
    let channelChartInstance = null;

    function renderChannelChart(labels, values01) {
      const ctx = document.getElementById("channelChart");

      if (channelChartInstance) channelChartInstance.destroy();

      channelChartInstance = new Chart(ctx, {
        type: "bar",
        data: {
          labels,
          datasets: [{
            label: "ë‹¬ì„±ìœ¨(%)",
            data: values01.map(v => Number(v) * 100)
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    }

    /********************************************************
     * ë°ì´í„° ë¡œë”
     ********************************************************/
    async function loadSummary() {
      const d = await jsonp(API_URL + "?action=summary");
      if (d && d.error) throw new Error(d.error);
      renderKpis(d);
    }

    async function loadChannel() {
      const d = await jsonp(API_URL + "?action=bar&by=ë°©ì†¡ì±„ë„&metric=ë‹¬ì„±ìœ¨&agg=mean&top=30");
      if (d && d.error) throw new Error(d.error);
      renderChannelChart(d.labels || [], d.values || []);
    }

    async function refreshAll() {
      try {
        setStatus(true, "ë¡œë”© ì¤‘â€¦");
        await loadSummary();
        await loadChannel();
        updateTimestamp();
        setStatus(true, "ì •ìƒ", "ë°ì´í„° ë¡œë“œ ì™„ë£Œ");
      } catch (err) {
        console.error(err);
        setStatus(false, "ì˜¤ë¥˜", err.message || String(err));
      }
    }

    // ë²„íŠ¼
    document.getElementById("refreshBtn").addEventListener("click", () => {
      refreshAll();
    });

    // ìµœì´ˆ ë¡œë“œ
    refreshAll();

    // ìë™ ê°±ì‹ (ì›í•˜ë©´ ì£¼ê¸° ì¡°ì ˆ)
    setInterval(() => { loadSummary().then(updateTimestamp).catch(console.error); }, 10000); // 10ì´ˆë§ˆë‹¤ KPI
    setInterval(() => { loadChannel().catch(console.error); }, 30000); // 30ì´ˆë§ˆë‹¤ ì°¨íŠ¸
  </script>
</body>
</html>
