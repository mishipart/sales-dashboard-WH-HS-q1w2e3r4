<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ë°©ì†¡ ë§¤ì¶œ ëŒ€ì‹œë³´ë“œ</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg:#f6f8fb;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;
      --accent:#60a5fa;
      --accent2:#fb7185;
      --accent3:#f59e0b;
      --shadow: 0 1px 2px rgba(0,0,0,.05), 0 8px 24px rgba(0,0,0,.06);
      --radius: 16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", "Apple SD Gothic Neo", Arial;
      background:var(--bg);
      color:var(--text);
    }
    header{
      padding:18px 18px 10px;
      max-width:1280px;
      margin:0 auto;
    }
    .title{
      display:flex; align-items:center; gap:10px;
      font-size:28px; font-weight:900;
    }
    .subtitle{
      margin-top:6px;
      color:var(--muted);
      font-size:13px;
    }

    .topbar{
      margin-top:12px;
      background:var(--card);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .status{
      font-size:13px;
      color:var(--muted);
    }
    .status b{color:#065f46}
    .status .err b{color:#b91c1c}
    .actions{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
      color:var(--muted);
      font-size:12px;
    }
    .btn{
      border:1px solid var(--line);
      background:#fff;
      padding:7px 10px;
      border-radius: 10px;
      cursor:pointer;
      font-weight:700;
      font-size:12px;
    }
    .btn.primary{
      background:#eef2ff;
      border-color:#c7d2fe;
      color:#1d4ed8;
    }

    main{
      max-width:1280px;
      margin: 14px auto 36px;
      padding:0 18px;
      display:grid;
      grid-template-columns: 320px 1fr;
      gap:14px;
      align-items:start;
    }

    /* Filters */
    .panel{
      background:var(--card);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:12px;
    }
    .panel h3{
      margin:0 0 10px;
      font-size:14px;
      font-weight:900;
    }
    .filterBlock{
      margin-top:10px;
      border-top:1px dashed #eef0f4;
      padding-top:10px;
    }
    .filterHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      margin-bottom:8px;
    }
    .filterHeader .label{
      font-size:13px;
      font-weight:900;
    }
    .filterHeader .miniBtns{
      display:flex; gap:6px;
    }
    .mini{
      border:1px solid var(--line);
      background:#fff;
      padding:5px 8px;
      border-radius: 10px;
      cursor:pointer;
      font-weight:800;
      font-size:11px;
      color:#111827;
    }

    .chips{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
    }
    .chip{
      border:1px solid var(--line);
      background:#fff;
      padding:6px 10px;
      border-radius: 999px;
      font-size:12px;
      cursor:pointer;
      user-select:none;
    }
    .chip.on{
      border-color:#93c5fd;
      background:#eff6ff;
      color:#1d4ed8;
      font-weight:900;
    }

    /* Content */
    .content{
      display:flex;
      flex-direction:column;
      gap:14px;
    }

    .kpis{
      display:grid;
      grid-template-columns: repeat(6, minmax(0, 1fr));
      gap:10px;
    }
    .kpi{
      background:#eaf2ff;
      border-radius: 14px;
      padding:12px 14px;
      min-height:74px;
      display:flex;
      flex-direction:column;
      justify-content:center;
      gap:4px;
    }
    .kpi .k{
      color:#375a8c;
      font-size:12px;
      font-weight:800;
    }
    .kpi .v{
      font-size:20px;
      font-weight:1000;
      color:#0f172a;
    }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
    }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:12px;
    }
    .card h4{
      margin:0 0 10px;
      font-size:13px;
      font-weight:1000;
    }
    .chartWrap{
      height:260px; /* ê·¸ë˜í”„ í¬ê¸° ì¤„ì„ */
    }
    .chartWrap.tall{
      height:320px;
    }

    .footnote{
      margin-top:10px;
      color:var(--muted);
      font-size:11px;
    }

    /* Modal */
    .modalOverlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,.45);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:1000;
    }
    .modal{
      width:min(520px, 100%);
      background:#fff;
      border-radius: 18px;
      padding:16px;
      box-shadow: 0 12px 48px rgba(0,0,0,.25);
      border:1px solid rgba(0,0,0,.08);
    }
    .modal h3{margin:0 0 8px; font-size:16px; font-weight:1000}
    .modal p{margin:0 0 12px; color:var(--muted); font-size:13px; line-height:1.4}
    .row{
      display:flex; gap:8px; align-items:center;
    }
    input[type="password"], input[type="text"]{
      width:100%;
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius: 12px;
      outline:none;
      font-size:14px;
    }
    .msg{
      margin-top:10px;
      font-size:12px;
      color:#b91c1c;
      display:none;
      font-weight:800;
    }

    @media (max-width: 1100px){
      main{grid-template-columns: 1fr;}
      .kpis{grid-template-columns: repeat(3, minmax(0, 1fr));}
      .grid2{grid-template-columns: 1fr;}
    }
  </style>
</head>
<body>
<header>
  <div class="title">ğŸ“Š ë°©ì†¡ ë§¤ì¶œ ëŒ€ì‹œë³´ë“œ</div>
  <div class="subtitle">ì—‘ì…€ ìŠ¬ë¼ì´ì„œì²˜ëŸ¼ ì„ íƒí•˜ë©´ KPI/ì°¨íŠ¸ê°€ ì¦‰ì‹œ ë³€ê²½ë©ë‹ˆë‹¤.</div>

  <div class="topbar">
    <div class="status" id="statusText">ìƒíƒœ: <b>ëŒ€ê¸°</b> Â· í‚¤ ì¸ì¦ í•„ìš”</div>
    <div class="actions">
      <span id="updatedAt">ì—…ë°ì´íŠ¸: -</span>
      <button class="btn" id="btnReset">ì „ì²´ í•´ì œ</button>
      <button class="btn primary" id="btnReload">ìƒˆë¡œê³ ì¹¨</button>
    </div>
  </div>
</header>

<main>
  <!-- Filters -->
  <section class="panel">
    <h3>í•„í„°(ìŠ¬ë¼ì´ì„œ)</h3>

    <div class="filterBlock" id="blkYears">
      <div class="filterHeader">
        <div class="label">ì—°ë„</div>
        <div class="miniBtns">
          <button class="mini" data-act="all" data-k="years">ì „ì²´</button>
          <button class="mini" data-act="clear" data-k="years">í•´ì œ</button>
        </div>
      </div>
      <div class="chips" id="chipsYears"></div>
    </div>

    <div class="filterBlock" id="blkMonths">
      <div class="filterHeader">
        <div class="label">ì›”</div>
        <div class="miniBtns">
          <button class="mini" data-act="all" data-k="months">ì „ì²´</button>
          <button class="mini" data-act="clear" data-k="months">í•´ì œ</button>
        </div>
      </div>
      <div class="chips" id="chipsMonths"></div>
    </div>

    <div class="filterBlock" id="blkDays">
      <div class="filterHeader">
        <div class="label">ì¼</div>
        <div class="miniBtns">
          <button class="mini" data-act="all" data-k="days">ì „ì²´</button>
          <button class="mini" data-act="clear" data-k="days">í•´ì œ</button>
        </div>
      </div>
      <div class="chips" id="chipsDays"></div>
    </div>

    <div class="filterBlock" id="blkDows">
      <div class="filterHeader">
        <div class="label">ìš”ì¼</div>
        <div class="miniBtns">
          <button class="mini" data-act="all" data-k="dows">ì „ì²´</button>
          <button class="mini" data-act="clear" data-k="dows">í•´ì œ</button>
        </div>
      </div>
      <div class="chips" id="chipsDows"></div>
    </div>

    <div class="filterBlock" id="blkItems">
      <div class="filterHeader">
        <div class="label">ì•„ì´í…œ</div>
        <div class="miniBtns">
          <button class="mini" data-act="all" data-k="items">ì „ì²´</button>
          <button class="mini" data-act="clear" data-k="items">í•´ì œ</button>
        </div>
      </div>
      <div class="chips" id="chipsItems"></div>
    </div>

    <div class="filterBlock" id="blkChannels">
      <div class="filterHeader">
        <div class="label">ë°©ì†¡ì±„ë„</div>
        <div class="miniBtns">
          <button class="mini" data-act="all" data-k="channels">ì „ì²´</button>
          <button class="mini" data-act="clear" data-k="channels">í•´ì œ</button>
        </div>
      </div>
      <div class="chips" id="chipsChannels"></div>
    </div>

    <div class="footnote">â€» í‚¤ë¥¼ ëª¨ë¥´ë©´ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>
  </section>

  <!-- Content -->
  <section class="content">
    <div class="kpis">
      <div class="kpi"><div class="k">ë°©ì†¡íšŸìˆ˜</div><div class="v" id="kpiCnt">-</div></div>
      <div class="kpi"><div class="k">íŠ¹ì•½íšŸìˆ˜</div><div class="v" id="kpiSpCnt">-</div></div>
      <div class="kpi"><div class="k">íŠ¹ì•½ë¹„ìš©</div><div class="v" id="kpiSpCost">-</div></div>
      <div class="kpi"><div class="k">í‰ê· ë‹¬ì„±ìœ¨</div><div class="v" id="kpiAch">-</div></div>
      <div class="kpi"><div class="k">ë°©ì†¡ì‹œê°„(ë¶„)</div><div class="v" id="kpiMin">-</div></div>
      <div class="kpi"><div class="k">ì‹œê°„ë‹¹ë§¤ì¶œ</div><div class="v" id="kpiHr">-</div></div>
    </div>

    <div class="grid2">
      <div class="card">
        <h4>ë°©ì†¡ì±„ë„ë³„ (ëª©í‘œ/ì‹¤ì /ë‹¬ì„±ìœ¨)</h4>
        <div class="chartWrap"><canvas id="chChannel"></canvas></div>
      </div>
      <div class="card">
        <h4>ì›”ë³„ (ëª©í‘œ/ì‹¤ì /ë‹¬ì„±ìœ¨)</h4>
        <div class="chartWrap"><canvas id="chMonth"></canvas></div>
      </div>
      <div class="card">
        <h4>ìš”ì¼ë³„ (ëª©í‘œ/ì‹¤ì /ë‹¬ì„±ìœ¨)</h4>
        <div class="chartWrap"><canvas id="chDow"></canvas></div>
      </div>
      <div class="card">
        <h4>ì¼ìë³„ (ëª©í‘œ/ì‹¤ì /ë‹¬ì„±ìœ¨) - TOP 30</h4>
        <div class="chartWrap tall"><canvas id="chDay"></canvas></div>
      </div>
    </div>

    <div class="card">
      <h4>ì•„ì´í…œë³„ (ëª©í‘œ/ì‹¤ì /ë‹¬ì„±ìœ¨)</h4>
      <div class="chartWrap tall"><canvas id="chItem"></canvas></div>
    </div>
  </section>
</main>

<!-- Key modal -->
<div class="modalOverlay" id="keyModal">
  <div class="modal">
    <h3>í‚¤ ì¸ì¦</h3>
    <p>ì´ í˜ì´ì§€ëŠ” ë¹„ê³µê°œ ë°ì´í„°ì…ë‹ˆë‹¤. ì ‘ê·¼ í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
    <div class="row">
      <input id="keyInput" type="password" placeholder="í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”" autocomplete="current-password" />
      <button class="btn primary" id="keyOk">í™•ì¸</button>
    </div>
    <div class="msg" id="keyMsg">í‚¤ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.</div>
    <div style="margin-top:10px; color:var(--muted); font-size:12px;">
      Â· í‚¤ëŠ” ë¸Œë¼ìš°ì €ì—ë§Œ ì €ì¥ë©ë‹ˆë‹¤(ì„œë²„ ì €ì¥ ì—†ìŒ).<br/>
      Â· í‚¤ë¥¼ ë³€ê²½í–ˆë‹¤ë©´ ì €ì¥ëœ í‚¤ë¥¼ ì§€ìš°ê³  ë‹¤ì‹œ ì…ë ¥í•˜ì„¸ìš”.
    </div>
  </div>
</div>

<script>
/** ===========================
 *  0) ë°˜ë“œì‹œ ì—¬ê¸°ë§Œ ìˆ˜ì •í•˜ì„¸ìš”
 * =========================== */

// âœ… 1) Apps Script ì›¹ì•± ì‹¤í–‰ URL (ëì´ /exec ë¡œ ëë‚˜ëŠ” ì£¼ì†Œ)
const API_EXEC_URL = "https://script.google.com/macros/s/AKfycbzpLQ2wcNZIuisAjsaDTxA_Lj1E5X6CWEeZffW0_PPdjHTAo7peoHig1UmzyvXbkLHUuw/exec";

// âœ… 2) ê¸°ë³¸ í‚¤(ì›í•˜ë©´ ë¹„ì›Œë‘ê³ , íŒì—…ì—ì„œë§Œ ì…ë ¥í•˜ê²Œ í•´ë„ ë¨)
//    - ì‚¬ìš©ìê°€ ë°”ê¿”ë‘” í‚¤ë¡œ ìˆ˜ì • ê°€ëŠ¥í•˜ë„ë¡ í‘œê¸°ë§Œ í•´ë‘ 
const DEFAULT_KEY = "WHHS-PSM-221035"; // ì˜ˆ: "WHHS-ONLY-2026-SECRET"


/** ===========================
 *  1) ìœ í‹¸
 * =========================== */
const $ = (id)=>document.getElementById(id);

function setStatus(ok, msg){
  const el = $("statusText");
  if(ok){
    el.innerHTML = `ìƒíƒœ: <b>ì •ìƒ</b> Â· ${msg || "ë¡œë“œ ì™„ë£Œ"}`;
  }else{
    el.innerHTML = `ìƒíƒœ: <span class="err"><b>ì˜¤ë¥˜</b></span> Â· ${msg || "ë¬¸ì œ ë°œìƒ"}`;
  }
}

function fmtInt(n){
  n = Number(n||0);
  return n.toLocaleString("ko-KR");
}
function fmtMoney(n){
  n = Number(n||0);
  return n.toLocaleString("ko-KR");
}
function fmtPctFromRatio(ratio){
  // ratio: 0~1
  const v = Number(ratio||0) * 100;
  return `${v.toFixed(0)}%`;
}
function toPctValue(v){
  // ì–´ë–¤ ì…ë ¥ì´ ì™€ë„ ìµœì¢…ì ìœ¼ë¡œ "í¼ì„¼íŠ¸ ìˆ«ì(ì˜ˆ: 82)"ë¡œ ë³€í™˜
  if (v === null || v === undefined) return 0;
  if (typeof v === "string"){
    const s = v.trim().replace(/,/g,'');
    if (!s) return 0;
    if (s.endsWith("%")){
      const n = parseFloat(s.slice(0,-1));
      return isFinite(n) ? n : 0;
    }
    const n = parseFloat(s);
    if (!isFinite(n)) return 0;
    // 0~1ì´ë©´ ë¹„ìœ¨ë¡œ ë³´ê³  %ë¡œ í™˜ì‚°
    if (n <= 1.5) return n * 100;
    // 82 ê°™ì€ ê°’ì´ë©´ ì´ë¯¸ %ë¡œ ê°„ì£¼
    return n;
  }
  const n = Number(v);
  if (!isFinite(n)) return 0;
  if (n <= 1.5) return n * 100;
  return n;
}

function loadFromStorageKey(){
  return localStorage.getItem("dash_key") || "";
}
function saveToStorageKey(k){
  localStorage.setItem("dash_key", k);
}

/** JSONP í˜¸ì¶œ */
function jsonp(url, timeoutMs=15000){
  return new Promise((resolve, reject)=>{
    const cb = "cb_" + Math.random().toString(16).slice(2);
    const script = document.createElement("script");
    let timer = null;

    window[cb] = (data)=>{
      cleanup();
      resolve(data);
    };

    function cleanup(){
      if(timer) clearTimeout(timer);
      delete window[cb];
      if(script && script.parentNode) script.parentNode.removeChild(script);
    }

    timer = setTimeout(()=>{
      cleanup();
      reject(new Error("JSONP timeout"));
    }, timeoutMs);

    script.src = url + (url.includes("?") ? "&" : "?") + "callback=" + cb + "&_ts=" + Date.now();
    script.onerror = ()=>{
      cleanup();
      reject(new Error("JSONP load failed"));
    };
    document.head.appendChild(script);
  });
}

/** ì¿¼ë¦¬ ë§Œë“¤ê¸° */
function qs(params){
  const sp = new URLSearchParams();
  Object.entries(params).forEach(([k,v])=>{
    if(v === undefined || v === null) return;
    if(Array.isArray(v)){
      v.forEach(x=> sp.append(k, x));
    }else{
      sp.set(k, v);
    }
  });
  return sp.toString();
}

/** ===========================
 *  2) ìƒíƒœ/í•„í„°
 * =========================== */
const state = {
  key: "",
  filters: {
    years: [],
    months: [],
    days: [],
    dows: [],
    items: [],
    channels: []
  },
  options: null,
  charts: {}
};

function clearFilters(){
  state.filters = { years:[], months:[], days:[], dows:[], items:[], channels:[] };
  renderAllChips();
}

function setAll(k){
  if(!state.options) return;
  state.filters[k] = (state.options[k] || []).slice();
  renderChips(k);
}

function toggleFilter(k, val){
  const arr = state.filters[k];
  const idx = arr.indexOf(val);
  if(idx >= 0) arr.splice(idx,1);
  else arr.push(val);
  renderChips(k);
}

/** ===========================
 *  3) ë Œë”(ì¹©)
 * =========================== */
function makeChip(containerId, k, val){
  const el = document.createElement("div");
  el.className = "chip";
  el.textContent = val;
  el.onclick = ()=>{
    toggleFilter(k, val);
    fetchDashboard();
  };
  return el;
}

function renderChips(k){
  const map = {
    years: "chipsYears",
    months: "chipsMonths",
    days: "chipsDays",
    dows: "chipsDows",
    items: "chipsItems",
    channels: "chipsChannels"
  };
  const wrap = $(map[k]);
  wrap.innerHTML = "";
  const all = (state.options && state.options[k]) ? state.options[k] : [];
  all.forEach(val=>{
    const chip = makeChip(map[k], k, val);
    if(state.filters[k].includes(val)) chip.classList.add("on");
    wrap.appendChild(chip);
  });
}

function renderAllChips(){
  ["years","months","days","dows","items","channels"].forEach(renderChips);
}

/** mini buttons */
document.addEventListener("click", (e)=>{
  const t = e.target;
  if(t && t.classList.contains("mini")){
    const act = t.dataset.act;
    const k = t.dataset.k;
    if(act === "all") setAll(k);
    if(act === "clear") state.filters[k] = [];
    renderChips(k);
    fetchDashboard();
  }
});

/** ===========================
 *  4) ì°¨íŠ¸ ìƒì„±/ì—…ë°ì´íŠ¸
 * =========================== */
function destroyChart(id){
  if(state.charts[id]){
    state.charts[id].destroy();
    delete state.charts[id];
  }
}

function makeComboChart(canvasId, payload, opts={}){
  // payload: { labels, goals, actuals, achs } where achs is ratio (0~1) recommended
  const ctx = $(canvasId);
  if(!ctx) return;

  const labels = payload.labels || [];
  const goals = (payload.goals || []).map(Number);
  const actuals = (payload.actuals || []).map(Number);

  // âœ… ë‹¬ì„±ìœ¨ì€ í™”ë©´ì—ì„œëŠ” %ë¡œ!
  const achPct = (payload.achs || []).map(toPctValue);

  destroyChart(canvasId);

  state.charts[canvasId] = new Chart(ctx, {
    type: opts.type || "bar",
    data: {
      labels,
      datasets: [
        {
          label: "ëª©í‘œ",
          data: goals,
          backgroundColor: "rgba(96,165,250,.55)",
          borderColor: "rgba(96,165,250,1)",
          borderWidth: 1,
          order: 2
        },
        {
          label: "ì‹¤ì ",
          data: actuals,
          backgroundColor: "rgba(251,113,133,.45)",
          borderColor: "rgba(251,113,133,1)",
          borderWidth: 1,
          order: 2
        },
        {
          // âœ… ë‹¬ì„±ìœ¨: ì„ ì„ ì‡ì§€ ì•Šê³  ì ë§Œ í¬ê²Œ í‘œì‹œ
          type: "scatter",
          label: "ë‹¬ì„±ìœ¨(%)",
          data: achPct.map((v,i)=>({ x: i, y: v })),
          yAxisID: "y1",
          showLine: false,
          pointRadius: 6,           // â† ìš”ì²­: ì  í¬ê²Œ
          pointHoverRadius: 8,
          borderColor: "rgba(245,158,11,1)",
          backgroundColor: "rgba(245,158,11,.55)",
          order: 1
        }
      ]
    },
    options: {
      responsive:true,
      maintainAspectRatio:false,
      plugins:{
        legend:{ position:"top" },
        tooltip:{
          callbacks:{
            label:(ctx)=>{
              const ds = ctx.dataset;
              const label = ds.label || "";
              if(label.includes("ë‹¬ì„±ìœ¨")){
                const v = ctx.parsed.y;
                return `ë‹¬ì„±ìœ¨: ${Number(v||0).toFixed(0)}%`;
              }
              const v = ctx.parsed.y ?? ctx.parsed;
              return `${label}: ${Number(v||0).toLocaleString("ko-KR")}`;
            }
          }
        }
      },
      scales:{
        x: {
          grid:{ color:"rgba(229,231,235,.7)" }
        },
        y: {
          beginAtZero:true,
          grid:{ color:"rgba(229,231,235,.7)" },
          ticks:{
            callback:(v)=>Number(v).toLocaleString("ko-KR")
          }
        },
        y1: {
          position:"right",
          beginAtZero:true,
          grid:{ drawOnChartArea:false },
          ticks:{
            callback:(v)=> `${v}%`
          }
        }
      }
    }
  });
}

function makeHComboChart(canvasId, payload){
  // ê°€ë¡œë§‰ëŒ€í˜•(ì¼ì TOP30 ë“±)
  const labels = payload.labels || [];
  const goals = (payload.goals || []).map(Number);
  const actuals = (payload.actuals || []).map(Number);
  const achPct = (payload.achs || []).map(toPctValue);

  destroyChart(canvasId);

  state.charts[canvasId] = new Chart($(canvasId), {
    type: "bar",
    data: {
      labels,
      datasets: [
        {
          label:"ëª©í‘œ",
          data: goals,
          backgroundColor: "rgba(96,165,250,.55)",
          borderWidth:1
        },
        {
          label:"ì‹¤ì ",
          data: actuals,
          backgroundColor: "rgba(251,113,133,.45)",
          borderWidth:1
        },
        {
          type:"scatter",
          label:"ë‹¬ì„±ìœ¨(%)",
          data: achPct.map((v,i)=>({ x: v, y: i })),
          xAxisID:"x1",
          showLine:false,
          pointRadius:6,
          pointHoverRadius:8,
          borderColor:"rgba(245,158,11,1)",
          backgroundColor:"rgba(245,158,11,.55)"
        }
      ]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      indexAxis:"y",
      plugins:{
        legend:{ position:"top" },
        tooltip:{
          callbacks:{
            label:(ctx)=>{
              const label = ctx.dataset.label || "";
              if(label.includes("ë‹¬ì„±ìœ¨")){
                return `ë‹¬ì„±ìœ¨: ${Number(ctx.parsed.x||0).toFixed(0)}%`;
              }
              return `${label}: ${Number(ctx.parsed.x||0).toLocaleString("ko-KR")}`;
            }
          }
        }
      },
      scales:{
        x:{
          beginAtZero:true,
          grid:{ color:"rgba(229,231,235,.7)" },
          ticks:{ callback:(v)=>Number(v).toLocaleString("ko-KR") }
        },
        x1:{
          position:"top",
          beginAtZero:true,
          grid:{ drawOnChartArea:false },
          ticks:{ callback:(v)=>`${v}%` }
        },
        y:{
          grid:{ color:"rgba(229,231,235,.7)" }
        }
      }
    }
  });
}

/** ===========================
 *  5) API í˜¸ì¶œ
 * =========================== */
async function fetchOptions(){
  const url = API_EXEC_URL + "?" + qs({
    action:"options",
    key: state.key
  });
  const data = await jsonp(url, 20000);
  if(data && data.error) throw new Error(data.message || data.error);
  return data;
}

async function fetchDashboard(){
  try{
    setStatus(true, "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...");
    const p = state.filters;

    const url = API_EXEC_URL + "?" + qs({
      action:"dashboard",
      key: state.key,
      years: p.years,
      months: p.months,
      days: p.days,
      dows: p.dows,
      items: p.items,
      channels: p.channels
    });

    const data = await jsonp(url, 25000);
    if(data && data.error) throw new Error(data.message || data.error);

    renderDashboard(data);
    $("updatedAt").textContent = "ì—…ë°ì´íŠ¸: " + new Date().toLocaleString("ko-KR");
    setStatus(true, "í•„í„° ì ìš© ì™„ë£Œ");
  }catch(err){
    console.error(err);
    setStatus(false, err.message || "JSONP load failed");
  }
}

/** ===========================
 *  6) ë Œë”(ëŒ€ì‹œë³´ë“œ)
 * =========================== */
function renderDashboard(d){
  const s = d.summary || {};
  $("kpiCnt").textContent = fmtInt(s.ë°©ì†¡íšŸìˆ˜);
  $("kpiSpCnt").textContent = fmtInt(s.íŠ¹ì•½íšŸìˆ˜);
  $("kpiSpCost").textContent = fmtMoney(s.íŠ¹ì•½ë¹„ìš©);
  $("kpiAch").textContent = fmtPctFromRatio(s.í‰ê· ë‹¬ì„±ìœ¨); // âœ… 0~1 â†’ 80%
  $("kpiMin").textContent = fmtInt(s.ë°©ì†¡ì‹œê°„_ë¶„);
  $("kpiHr").textContent = fmtMoney(s.ì‹œê°„ë‹¹ë§¤ì¶œ);

  // ì°¨íŠ¸
  // 1) ì±„ë„: ë¬¸ìì—´ ë‚´ë¦¼ì°¨ìˆœ / (ë¹„ì–´ìˆìŒ ì œê±°ëŠ” ë°±ì—”ë“œì—ì„œ ì²˜ë¦¬)
  makeComboChart("chChannel", d.channel, { type:"bar" });

  // 2) ì›”
  makeComboChart("chMonth", d.month, { type:"bar" });

  // 3) ìš”ì¼
  makeComboChart("chDow", d.dow, { type:"bar" });

  // 4) ì¼ì: ê°€ë¡œ ë§‰ëŒ€
  makeHComboChart("chDay", d.day);

  // 5) ì•„ì´í…œ: ì„¸ë¡œ ë§‰ëŒ€(ìš”ì²­) + ë‹¬ì„±ìœ¨ ì ë§Œ
  makeComboChart("chItem", d.item, { type:"bar" });
}

/** ===========================
 *  7) í‚¤ ì¸ì¦ íë¦„
 * =========================== */
function openKeyModal(){
  $("keyModal").style.display = "flex";
  $("keyInput").value = state.key || "";
  $("keyMsg").style.display = "none";
  $("keyInput").focus();
}
function closeKeyModal(){
  $("keyModal").style.display = "none";
}

async function verifyKeyAndInit(){
  try{
    setStatus(true, "í‚¤ í™•ì¸ ì¤‘...");
    // options í˜¸ì¶œë¡œ í‚¤ ê²€ì¦ + í•„í„° ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
    const opt = await fetchOptions();
    state.options = opt;
    renderAllChips();
    closeKeyModal();
    setStatus(true, "í‚¤ ì¸ì¦ ì™„ë£Œ");
    await fetchDashboard();
  }catch(err){
    console.error(err);
    $("keyMsg").style.display = "block";
    setStatus(false, "í‚¤ ì¸ì¦ ì‹¤íŒ¨");
  }
}

/** ===========================
 *  8) ì´ë²¤íŠ¸
 * =========================== */
$("btnReload").onclick = ()=> fetchDashboard();
$("btnReset").onclick = ()=>{
  clearFilters();
  fetchDashboard();
};

$("keyOk").onclick = ()=>{
  const k = $("keyInput").value.trim();
  state.key = k;
  saveToStorageKey(k);
  verifyKeyAndInit();
};
$("keyInput").addEventListener("keydown", (e)=>{
  if(e.key === "Enter") $("keyOk").click();
});

/** ===========================
 *  9) ì‹œì‘
 * =========================== */
(function init(){
  // í‚¤ ë¶ˆëŸ¬ì˜¤ê¸°: localStorage â†’ DEFAULT_KEY
  state.key = loadFromStorageKey() || (DEFAULT_KEY || "");
  if(!state.key){
    openKeyModal();
    return;
  }
  // í‚¤ê°€ ìˆìœ¼ë©´ ë°”ë¡œ ê²€ì¦/ë¡œë“œ
  verifyKeyAndInit();
})();
</script>
</body>
</html>
